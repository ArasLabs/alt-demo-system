<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- (c) Copyright by Aras Corporation, 2004-2008. -->
<html>
<head>
  <title></title>
  <link rel="stylesheet" type="text/css" href="../styles/default.css" />
  <style type="text/css">
    html, body
    {
      margin: 0;
      padding: 0;
      height: 100%;
      border: none;
    }
  </style>

  <script type="text/javascript">
    var scripts_url = (top.aras) ? top.aras.getScriptsURL() : "";
    if (scripts_url) document.writeln('<base HREF="' + scripts_url + '" />');
  </script>

  <script type="text/javascript" src="../javascript/AddConfigurationLink.js"></script>

  <script type="text/javascript" src="../javascript/scriptset2.aspx"></script>

  <script type="text/javascript" src="../javascript/scriptset6.aspx"></script>

</head>
<body ondragenter="event.returnValue=false;" ondragover="event.returnValue=false;" ondrop="event.returnValue=false;">

  <script type="text/javascript">
    //+++++ Public Methods +++++
    function markPopupMenuEntryExcluded(entryId, isExcluded, doResetEntryVal)
    {
      updateGlobalHash(ExcludedPopupMenuEntries, entryId, isExcluded, doResetEntryVal, true);
    }

    function markPopupMenuEntryVisible(entryId, isVisible, doReset)
    {
      updateGlobalHash(ExplicitPopupMenuEntriesVisibilities, entryId, isVisible, doReset, true);
    }

    function markToolbarIconEnabled(iconId, isEnabled, doReset)
    {
      updateGlobalHash(ExplicitToolbarIconsEnabling, iconId, isEnabled, doReset, true);
    }
    //----- Public Methods -----

    function updateGlobalHash(hashObj, entryId, val, doReset, defaultVal)
    {
      if (doReset)
      {
        delete hashObj[entryId];
        return;
      }
      if (val === undefined) val = defaultVal;
      hashObj[entryId] = val;
    }

    var mainWnd = top.aras.getMainWindow();
    if (!mainWnd.Cache)
      mainWnd.Cache = mainWnd.aras.newObject();

    var userID = top.aras.getUserID();
    var loginName = top.aras.getLoginName();

    var scriptReady = false;

    var gridReady = false;
    var toolbarReady = false;

    var activeToolbar = null;

    var PickRelatedOption = undefined;
    var CreateRelatedOption = undefined;
    var NoRelatedOption = undefined;

    var related_visible = true;

    var replaceButtonEnabled = false;
    var replaceFlag = true;
    var replaceToNull = true;
    var canNewFlag = true;

    var doSkipRedLiningOnXmlLoad = false; 
    var isRedlineActive = false;
    var isGridRedlinable = false;

    //names for varstorage
    var varName_redlineView;
    var varName_searchModeId;
    var varName_searchAml;



    //var Cache = mainWnd.Cache;
    var Cache = new Object(); // short lived cache for the lists only for the duration of this window.
    Cache.Lists = mainWnd.aras.newObject();

    //+++ global variables to use custom event handlers
    var relatedItemTypeName = "";
    var relationshipTypeName = "";
    //^^^ global variables to use custom event handlers

    //global variables
    var RelType_ID = QueryString("relTypeID").toString();

    var WorkFlowProc = QueryString("WorkFlowProc").toString();

    var RelType_Nm = "";
    var RelType_Lbl = "";
    var RelType_Nd = null;
    var MAX_OCCURS, MIN_OCCURS;
    var RELATED_IT_NAME = "";
    var RELATED_IT_LABEL = "";
    var RELATED_IS_DEPENDENT = false;

    var DescByItemType_ID = "";
    var DescByItemType_Nd = null;
    var DescByVisibleProps = null;

    var RelatedItemType_ID = "";
    var RelatedItemType_Nd = null;
    var RelatedVisibleProps = null;

    //--- ui
    var varName_pagesize;
    var varName_colOrder;
    var varName_colWidths;
    
    var bSHOW_INPUT_ROW = false; // determine show or hide input row in grid
    var CAN_RUN_SEARCH = false;
    var bTOOLBAR_IS_USED = (QueryString("toolbar").toString() == "1");
    var CUSTOM_TOOLBAR_SRC = QueryString("custom_toolbar_src").toString();

    var bCreateNew = false;
    var bTabEnterPressed = false;
    var bGridStarted = false;

    /// keyedName
    var bKEYEDNAME_INPUT_IS_IN_PROGRESS = false;  //  ability to directly key a value in the field/cell(against Dialog)
    var bML_STRING_INPUT_IS_IN_PROGRESS = false;

    var itemID = QueryString("itemID").toString();
    var itemTypeName = QueryString("ITName").toString();
    var itemTypeId = top.aras.getItemTypeId(itemTypeName);

    var relationshipTypeActions = new Object();
    var relationshipActions = new Object();

    var item = null;

    var propsArr = new Array(); //array of properties attributes: name, DRL, data_type, data_source

    var AUTO_SEARCH_FLAG = false;

    var languagesCount = 1;

    var CONTROLS_STATE_ARRAY = new Object(); //is used for popup menu initialization
    //setControlEnabled saves information here
    //to synchronize toolbar controls and popup menu state
    var ExcludedPopupMenuEntries = new Object();
    var ExplicitPopupMenuEntriesVisibilities = new Object();
    var ExplicitToolbarIconsEnabling = new Object();
    var LATEST_DOM_FROM_SERVER = top.aras.createXMLDocument();
    LATEST_DOM_FROM_SERVER.loadXML("<latest_result/>");

    var isEditMode = (QueryString("editMode").toString() == "1");
    var isPopupDisabled = (QueryString("popupDisabled").toString() == "1");

    // UI
    var gridApplet = null;
    var RTActionsCount = 0;

    var deletedFont_const = 'Arial-italic-8';
    var deletedTextColor_const = '#b0b0b0';

    var currSelCell = null; //variables to know what cell is being edited
    var currSelRowId = ''; //setted in onGridCellEdit
    var currSelCol = ''; //setted in onGridCellEdit

    var actionsMenuInitialized = false;
    var filterFlg = false;

    // +++ timeouts
    var UT_tmt = 0;
    // --- timeouts

    var rowEventsNames = new Array();
    var rowEventsMethods_code = new Array();
    var cellEventsNames = new Array();
    var cellEventsMethods_code = new Array();

    searchLocation = "Relationships Grid";

    if (!onInitialize())
    {
      top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.initialize_relshipgrid"));
      top.close();
    }

    initItem();

    function onInitialize()
    {
      bGridStarted = true;
      if (!RelType_ID || !top.aras.getMainWindow())
        return false;
      
      RelType_Nd = top.aras.getRelationshipType(RelType_ID).node;
      RelType_Nm = top.aras.getItemProperty(RelType_Nd, 'name');
      RelType_Lbl = top.aras.getItemProperty(RelType_Nd, 'label');
      if (RelType_Lbl == "") RelType_Lbl = RelType_Nm;

      currQryItem = top.aras.newQryItem(RelType_Nm);

      computeColWidhtOrder();

      // +++ global variables to use custom event handlers
      relatedItemTypeName = RELATED_IT_NAME;
      relationshipTypeName = RelType_Nm;
      // --- global variables to use custom event handlers

      if (top.aras.getLanguagesResultNd() && top.aras.getLanguagesResultNd().selectNodes("Item[@type='Language']"))
        languagesCount = top.aras.getLanguagesResultNd().selectNodes("Item[@type='Language']").length;

      if (AUTO_SEARCH_FLAG)
        bSHOW_INPUT_ROW = !isSearchRowEmpty(); //search row contains some criteria
      else
        bSHOW_INPUT_ROW = true;

      CAN_RUN_SEARCH = bSHOW_INPUT_ROW;
      return true;
    }

    function computeColWidhtOrder()
    {
      DescByItemType_ID = top.aras.getItemProperty(RelType_Nd, "relationship_id");
      DescByItemType_Nd = top.aras.getItemTypeDictionary(top.aras.getItemTypeName(DescByItemType_ID)).node;

      RelatedItemType_ID = top.aras.getItemProperty(RelType_Nd, "related_id");
      if (RelatedItemType_ID)
      {
        RelatedItemType_Nd = top.aras.getItemTypeDictionary(top.aras.getItemTypeName(RelatedItemType_ID)).node;

        RELATED_IT_NAME = top.aras.getItemProperty(RelatedItemType_Nd, "name");
        RELATED_IT_LABEL = top.aras.getItemProperty(RelatedItemType_Nd, "label");
        if (RELATED_IT_LABEL == "") RELATED_IT_LABEL = RELATED_IT_NAME;
        RELATED_IS_DEPENDENT = (top.aras.getItemProperty(RelatedItemType_Nd, "is_dependent") == "1");
      }

      varName_pagesize = "RT_" + RelType_ID + "_pageSize";
      varName_colOrder = "RT_" + RelType_ID + "_colOrder";
      varName_colWidths = "RT_" + RelType_ID + "_colWidths";
      varName_maxrecords = "RT_" + RelType_ID + "_maxRecords";
      
      AUTO_SEARCH_FLAG = (top.aras.getItemProperty(RelType_Nd, "auto_search") == "1");
      pagesize = top.aras.getVariable(varName_pagesize);
      if (!pagesize) pagesize = top.aras.getItemProperty(RelType_Nd, 'default_page_size');
      MAX_OCCURS = top.aras.getItemProperty(RelType_Nd, 'max_occurs');
      MIN_OCCURS = top.aras.getItemProperty(RelType_Nd, 'min_occurs');
      if (pagesize == "0") pagesize = "";
      if (pagesize) pagesize = parseInt(pagesize);
      if (MAX_OCCURS) MAX_OCCURS = parseInt(MAX_OCCURS);
      if (MIN_OCCURS) MIN_OCCURS = parseInt(MIN_OCCURS);

      // +++ global variables to use custom event handlers
      relatedItemTypeName = RELATED_IT_NAME;
      relationshipTypeName = RelType_Nm;
      // --- global variables to use custom event handlers

      var xpath = "Relationships/Item[@type='Property' and (not(is_hidden2) or is_hidden2='0')]";

      DescByVisibleProps = DescByItemType_Nd ? DescByItemType_Nd.selectNodes(xpath) : null;
      RelatedVisibleProps = RelatedItemType_Nd ? RelatedItemType_Nd.selectNodes(xpath) : null;

      DescByVisibleProps = top.aras.sortProperties(DescByVisibleProps);
      RelatedVisibleProps = top.aras.sortProperties(RelatedVisibleProps);

      var grid_view = top.aras.getItemProperty(RelType_Nd, "grid_view");
      top.aras.uiInitRelationshipsGridSetups(RelType_ID, DescByVisibleProps, RelatedVisibleProps, grid_view);

      propsArr = new Array();
      function addPropsFromArr(arr, DRL)
      {
        if (!arr) return false;

        for (var i = 0; i < arr.length; i++)
        {
          var prop = arr[i];
          var propNm = top.aras.getItemProperty(prop, "name");
          var propDRL = DRL;
          var data_type = top.aras.getItemProperty(prop, "data_type");
          var data_source = top.aras.getItemProperty(prop, "data_source");
          var propID_val = prop.getAttribute("id");
          var order_by = top.aras.getItemProperty(prop, "order_by");

          propsArr.push
      (
        {
          name: propNm,
          DRL: propDRL,
          data_type: data_type,
          data_source: data_source,
          propID: propID_val,
          order_by: order_by
        }
      );
        }
      }

      if (RelatedVisibleProps)
      {
        propsArr.push
    (
      {
        name: "L",
        DRL: "L",
        data_type: "",
        data_source: "",
        propID: "",
        order_by: ""
      }
    );
      }

      addPropsFromArr(DescByVisibleProps, "D");
      addPropsFromArr(RelatedVisibleProps, "R");

      calculateSortPriority(top.aras.getItemProperty(RelType_Nd, "grid_view"));
    }

    function getGenerateRelationshipsGridXML(dom)
    {
      var params = top.aras.newObject();
      params["enable_links"] = !isEditMode;
      params["bgInvert"] = true;
      params[RelatedItemType_ID] = "";

      return top.aras.uiGenerateRelationshipsGridXML(dom, DescByVisibleProps, RelatedVisibleProps, DescByItemType_ID, params, true);
    }
    
    function initGrid()
    {
      if (!gridReady || (bTOOLBAR_IS_USED && activeToolbar == null) || !top.aras)
      {
        setTimeout("initGrid()", 10);
        return;
      }

      if (!item) return; //this is possible in Workflow Map Editor. IR-004193

      gridApplet = document.grid;

      xml_ready_flag = false;

      setupGrid(true);
    }

    var addRowInProgress_Number = 0;
    function onXmlLoaded()
    {
      if (addRowInProgress_Number == 0)
      {
        setTimeout("sortRowByDefault()", 10);
      }
      else
      {
        addRowInProgress_Number--;

        if (addRowInProgress_Number == 0)
        {
          //          showGridInputRow(bSHOW_INPUT_ROW);
          gridApplet.setPaintEnabled(true);
          gridApplet.showContent();

          systemOnAfterAddRow();
        }
      }

      if (bTOOLBAR_IS_USED) updateToolbar();

      updateStatusBar();

      xml_ready_flag = true;
      updateDirtyRows();

      if (isRedlineActive && !doSkipRedLiningOnXmlLoad)
      {
        RefreshRedlineView();
      }
    }

    function updateDirtyRows()
    {
      var allRows = gridApplet.getAllItemIds(",");
      if (allRows == '') return;
      var re = new RegExp(/,/g);
      var dirtyItemIDs = "id='" + allRows.replace(re, "' or @id='") + "'";
      var dirtyItems = item.selectNodes("Relationships/Item[(" + dirtyItemIDs + ") and @action='update']");
      for (var i = 0; i < dirtyItems.length; i++)
      {
        var relatedNd = dirtyItems[i].selectSingleNode("related_id/Item");
        updateRow(dirtyItems[i], relatedNd, false, true, false);
      }
    }

    function showGridInputRow(b)
    {
      b = Boolean(b);
      var flg = gridApplet.IsInputRowVisible();
      if (flg == b) return;

      gridApplet.showInputRow(b);

      bSHOW_INPUT_ROW = b;
    }

    function isSearchRowEmpty()
    {
      return false;
    }

    function loadToolbar()
    {
      toolbar.setImageBase("../cbin/");
      toolbar.showLabels(top.aras.getVariable('ShowLabels') == 'true');
      if (WorkFlowProc != '1')
        toolbar.loadXml(top.aras.getI18NXMLResource("relationshipsGrid_toolbar.xml"));
      else
        toolbar.loadXml(top.aras.getI18NXMLResource("relationshipsGrid_toolbaforInstanceWf.xml"));

      toolbar.show();
      initToolbar();
    }

    onload = function onload_handler()
    {
      scriptInit();
      initSearch();
    }

    function RelationshipGridSearchContainer(itemTypeName, toolbar, grid, menu, searchLocation, searchPlaceholder, requiredProperties)
    {
      // Call base SearchContainer constructor
      SearchContainer.prototype.constructor.call(this, itemTypeName, toolbar, grid, menu, searchLocation, searchPlaceholder, requiredProperties);
    }
    
    RelationshipGridSearchContainer.prototype = new SearchContainer();
          
    function initSearch()
    {
      var searchForMenu = true;
      if (top.tearoff_menu && top.tearoff_menu.frameElement.style.display == "none")
        searchForMenu = false;
        
      if (!gridReady || (bTOOLBAR_IS_USED && !toolbarReady) || (searchForMenu && top.tearoff_menu && !top.tearoff_menu.menuApplet))
      {
        setTimeout('initSearch();', 10);
        return;
      }

      var toolbar4SearchContainer = null;
      if (CUSTOM_TOOLBAR_SRC && toolbar_slot_custom_iframe && toolbar_slot_custom_iframe.toolbar)
        toolbar4SearchContainer = toolbar_slot_custom_iframe.toolbar;
      else if (bTOOLBAR_IS_USED)
        toolbar4SearchContainer = toolbar;

      initMenu();
      initGrid();

      var menu4SearchContainer = null;
      if (top.tearoff_menu)
        menu4SearchContainer = top.tearoff_menu.menuApplet;

      var reqProps = new Object();
      reqProps["source_id"] = itemID;
      if (!searchContainer)
        searchContainer = new RelationshipGridSearchContainer(RelType_Nm, toolbar4SearchContainer, grid, menu4SearchContainer, searchLocation, searchPlaceholder, reqProps);

      if (this.frameElement && this.frameElement.className != "inactiveTab")
        searchContainer.onStartSearchContainer();

      currQryItem.setCriteria('source_id', itemID);
      currQryItem.setSelect(top.aras.getSelectCriteria(top.aras.getItemTypeId(RelType_Nm), true));
     
      initRedlinePreference();

      if(isRedlineActive)
      {
        RefreshRedlineView();
      }
      else
      {
        if (AUTO_SEARCH_FLAG) doSearch(); 	            
      }
      
    }

    function onSearchCommand()
    {
      doSearch();
    }

    function setControlEnabled(ctrlName, b)
    {
      if (b == undefined) b = true;
      else b = Boolean(b);

      if (ExplicitToolbarIconsEnabling[ctrlName] !== undefined) b = Boolean(ExplicitToolbarIconsEnabling[ctrlName]);

      CONTROLS_STATE_ARRAY[ctrlName] = b;

      try
      {
        var tbi = activeToolbar.getElement(ctrlName);
        if (tbi) tbi.setEnabled(b);
      } catch (excep) { }
      /*
      try {
      var mi  = document.menu.findItem(ctrlName);
      if (mi) mi.setEnabled(b);
      } catch(excep) {}
      */
    }


    function saveEditedData()
    {
      if (currSelCell)
      {
        gridApplet.setPaintEnabled(false);
        gridApplet.turnEditOff();
        gridApplet.setPaintEnabled(true);
      }
    }

    function replaceErrorHandler()
    {
      window.onerror = function() { return false; }
    }

    function initItem()
    {
      item = parent.item;
      itemTypeName = parent.itemTypeName;
      itemTypeId = top.aras.getItemTypeId(itemTypeName);
    }

    function setEditMode()
    {
      if ((isEditMode && itemTypeName == 'ItemType' && RelType_Nm == 'Property' && top.aras.getItemProperty(item, 'name') == 'Property')
      || (isEditMode && itemTypeName == 'RelationshipType' && RelType_Nm == 'Relationship Grid Event' && top.aras.getItemProperty(item, 'name') == 'Relationship Grid Event'))
      {
        // these are special cases when we need to reinitialize the interface completely
        // due to self-definition of the opened item
        // i.e. opened or being changed item shows itself
        var newLocation = location.href.replace(/editMode=./i, 'editMode=1');
        location.replace(newLocation);
      }
      else
      {
        isEditMode = true;

        initItem();
        doSearch();
        if (bTOOLBAR_IS_USED)
          updateToolbar();
      }
    }


    function setViewMode()
    {
      isEditMode = false;
      initItem();
      doSearch();
      if (bTOOLBAR_IS_USED)
        updateToolbar();
    }

    function initMenu()
    {
      setupMenu4RelationshipType();
    }

    function setupMenu4RelationshipType()
    {
      RTActionsCount = 0;

      if (bTOOLBAR_IS_USED)
      {
        var actionsTb = toolbar.GetItem("actions_menu");
        if (actionsTb)
        {
          actionsTb.RemoveAll();
          var RTActions = relationshipTypeActions[RelType_ID];
          if (RTActions) for (var menuEntry in RTActions)
          {
            actionsTb.Add(menuEntry, RTActions[menuEntry]);
            RTActionsCount++;
          }
        }
      }
    }

    function setupMenu4Relationship(add_remove)
    {
      if (bTOOLBAR_IS_USED)
      {
        var actionsTb = toolbar.GetItem("actions_menu");
        if (!actionsTb) return;

        var currCount = actionsTb.getItemCount();
        if (add_remove == "add")
        {
          if (currCount == RTActionsCount)
          {
            var RActions = relationshipActions[RelType_ID];
            if (RActions)
            {
              for (var menuEntry in RActions)
                actionsTb.add(menuEntry, RActions[menuEntry]);
            }
          }
        }
        else if (add_remove == "remove")
          if (currCount > RTActionsCount) setupMenu4RelationshipType();
      }
    }

    function onRelationshipsMenuClickItem(menuOptionId)
    {
      if (!RelType_Nd) return false;

      var act = top.aras.getItemFromServer('Action', menuOptionId, 'name,method(name,method_type,method_code),type,target,location,body,on_complete(name,method_type,method_code),item_query');
      if (!act) return false;
      var actType = act.getProperty('type');
      if (actType == 'itemtype')
        top.aras.invokeAction(act.node, top.aras.getItemProperty(RelType_Nd, 'relationship_id'), '');
      else
      {
        var ids = gridApplet.getSelectedItemIds(';').split(";");
        for (var i = 0; i < ids.length; i++)
        {
          if (ids[i] != "")
            top.aras.invokeAction(act.node, top.aras.getItemProperty(RelType_Nd, 'relationship_id'), ids[i]);
        }
      }
    }

    function removeChoiceItem(name)
    {
      if (name == undefined) return;
      var tbi = activeToolbar.getElement('related_option');
      try
      {
        tbi.remove(name);
      } catch (e)
      {
      }

      if (tbi.getItemCount() < 2)
      {
        setControlEnabled('related_option', false);
        related_visible = false;
      }
      else
        setControlEnabled('related_option', true);

      if (tbi.getItemCount() == 0)
        canNewFlag = false;
    }

    function getSelectedChoiceItem()
    {
      if (activeToolbar)
      {
        var tbi = activeToolbar.getElement('related_option');
        return tbi.getSelectedItem();
      }
      else return false;
    }

    function getChoiceItemName(id)
    {
      var tbi = activeToolbar.getElement('related_option');
      return tbi.getItem(id);
    }

    function initToolbar()
    {
      activeToolbar = toolbar.getActiveToolbar();
      //issue   IR-005671  to  reduce  toolbar  when user  look  workflow  proccesses
      if (WorkFlowProc != 1)
      {
        PickRelatedOption = getChoiceItemName(0);
        NoRelatedOption = getChoiceItemName(1);
        CreateRelatedOption = getChoiceItemName(2);

        var related_option = top.aras.getItemProperty(RelType_Nd, 'related_option');

        var opts = new Array();
        opts[PickRelatedOption] = false;
        opts[NoRelatedOption] = false;
        opts[CreateRelatedOption] = false;
        if (DescByItemType_Nd)
        {
          var RelTypeName = top.aras.getItemProperty(DescByItemType_Nd, 'name');
          var RelId = top.aras.getItemProperty(RelType_Nd, 'related_id');
          if (RelId != '')
          {
            var RelItem = RelatedItemType_Nd;

            var is_dependent = top.aras.getItemProperty(RelItem, 'is_dependent');
            is_dependent = ('1' == is_dependent);
            if (is_dependent)
            {
              opts[NoRelatedOption] = true;
              opts[PickRelatedOption] = true;
            }

            switch (related_option)
            {
              case '1':               //  Create Only
                opts[PickRelatedOption] = true;
                break;
              case '2':
                break;
              case '0':               //  Pick Only
              default:
                opts[CreateRelatedOption] = true;
            }
            if (top.aras.getItemProperty(RelType_Nd, 'related_notnull') == '1')
            {
              opts[NoRelatedOption] = true;
            }

          }
          else
          {
            opts[PickRelatedOption] = true;
            opts[CreateRelatedOption] = true;
          }

          for (opt in opts)
          {
            if (opts[opt]) removeChoiceItem(opt);
          }

          if (opts[PickRelatedOption] == true) replaceFlag = false;
          if (opts[NoRelatedOption] == true) replaceToNull = false;
        }
      }

      if (!bTOOLBAR_IS_USED)
        pagesize = ""; //otherwise User cannot see all the records
      else
      {
        if (pagesize != null)
          activeToolbar.getElement('page_size').setText(pagesize);
      }

      initFileControls();
      initCopyPasteControls();
      initRedlineControls();
    }


    function updateToolbar()
    {
      if (!gridApplet) return;
      //    var related_option = top.aras.getItemProperty(RelType_Nd, 'related_option');
      //    replaceButtonEnabled = isEditMode && (RELATED_IT_NAME != '') && (related_option!='1') && replaceFlag;
      replaceButtonEnabled = isEditMode && (RELATED_IT_NAME != '') && replaceFlag;

      setControlEnabled("new", computeCorrectControlState("new"));
      setControlEnabled("related_option", isEditMode && related_visible);
      if (gridApplet.getRowCount() > 0) setControlEnabled("select_all", true);

      setControlEnabled("delete", computeCorrectControlState("delete"));
      setControlEnabled("pick_replace", false)

      setControlEnabled('prev_page', page > 1);
      setControlEnabled('next_page', pagemax - page > 0);

      if (itemTypeName == "Life Cycle State" || itemTypeName == "Transition EMail" || itemTypeName == "Life Cycle Transition" || itemTypeName == "State EMail")
      {
        setControlEnabled("copy2clipboard", false);
        setControlEnabled("paste", false);
        setControlEnabled("paste_special", false);
      }
      else
      {
        setControlEnabled("copy2clipboard", gridApplet.getSelectedItemIds(";") != "" && !isWorkflowTool());
        var pasteFlg = getPasteFlg();
        setControlEnabled("paste", pasteFlg);
        var pasteSpecialFlg = getPasteSpecialFlg();
        setControlEnabled("paste_special", pasteSpecialFlg);
      }
    }

    function onToolbarButtonClick(btn)
    {
      if (!gridApplet || bKEYEDNAME_INPUT_IS_IN_PROGRESS)
        return;

      processCommand(btn.getId());
    }

    function setAllControlsEnabled(b)
    {
      /*
      * setAllControlsEnabled(b)
      *  enables/disables all controls in toolbar applets
      */
      var tbElements = new Array("new", "pick_replace", "delete", "export2Excel", "export2Word", "lock", "unlock", "promote", "search", "show_item", "show_relationship", "get_files",
      "checkout", "checkin", "get_files_related", "checkout_related", "checkin_related", "copy2clipboard", "paste", "select_all");

      for (var i = 0; i < tbElements.length; i++) setControlEnabled(tbElements[i], false);
    }

    function updateStatusBar()
    {
      if (bTOOLBAR_IS_USED && !activeToolbar)
      {
        setTimeout("updateStatusBar()", 10);
        return;
      }

      top.aras.showStatusMessage(1, getSearchResultStatusMessage());
    }

    function initFileControls()
    {
      if (!DescByItemType_Nd) return;

      var fileProps;

      fileProps = top.aras.getPropertiesOfTypeFile(DescByItemType_Nd);
      var bVisible = !(fileProps.length == 0);
      setControlVisible("get_files", bVisible);
      setControlVisible("checkout", bVisible);
      setControlVisible("checkin", bVisible);

      fileProps = null;
      if (RelatedItemType_Nd) fileProps = top.aras.getPropertiesOfTypeFile(RelatedItemType_Nd);
      bVisible = !(!fileProps || fileProps.length == 0);

      setControlVisible("get_files_related", bVisible);
      setControlVisible("checkout_related", bVisible);
      setControlVisible("checkin_related", bVisible);
    }

    function initCopyPasteControls()
    {
      if (itemTypeName == "Life Cycle State" || itemTypeName == "Life Cycle Transition" || itemTypeName == "State EMail")
      {
        setControlVisible("copy2clipboard", false);
        setControlVisible("paste", false);
        setControlVisible("paste_special", false);
      }
    }

    function initRedlinePreference()
    {    
      varName_redlineView = "RT_" + RelType_ID + "_redlineView";
      
      isRedlineActive = (isGridRedlinable && ("1" === top.aras.getVariable(varName_redlineView)));
      if (isRedlineActive)
        savedSearchAml_bckup = currentSearchMode.getAml();

      savedSearchID_bckup = currentSearchMode.id;

      if (activeToolbar)
      {
        var redline_btn = activeToolbar.GetElement('redline');
        if (redline_btn)
        {
          redline_btn.SetState(isRedlineActive);
        }
      }
    }

    function initRedlineControls()
    {
      var itemType = top.aras.getItemTypeForClient(itemTypeName, "name").node;
      var is_versionable = top.aras.getItemProperty(itemType, "is_versionable");

      isGridRedlinable = ("1" === is_versionable && ReleasedVersionExists());
      setControlEnabled("redline", isGridRedlinable);
    }

    function setControlVisible(id, show_it)
    {
      if (show_it) activeToolbar.showItem(id);
      else activeToolbar.hideItem(id);
    }

    function getLockedStatusStr(rowId)
    {
      var rNd = item.selectSingleNode("Relationships/Item[@type='" + RelType_Nm + "' and @id='" + rowId + "']/related_id/Item");

      if (!rNd) return "no_related";

      if (top.aras.isTempEx(rNd)) return "new";
      else if (top.aras.isLockedByUser(rNd)) return "user";
      else if (top.aras.isLocked(rNd)) return "alien";
      else return "";
    }

    function hasRelatedItem(rowId)
    {
      var rNd = item.selectSingleNode("Relationships/Item[@type='" + RelType_Nm + "' and @id='" + rowId + "']/related_id/Item");

      return (rNd != null);
    }

    function system_getRelatedItem(rowId)
    {
      var rNd = item.selectSingleNode("Relationships/Item[@type='" + RelType_Nm + "' and @id='" + rowId + "']/related_id/Item");

      return rNd;
    }

    function getUnlockFlg()
    {
      var ids = gridApplet.getSelectedItemIds(';').split(";");
      if (ids.length == 0) return false;

      for (var i = 0; i < ids.length; i++)
      {
        var rowId = ids[i];
        var locked = getLockedStatusStr(rowId);

        if (locked == "alien" && top.aras.isAdminUser())
        {
          //means "can unlock"
        }
        else if (locked != "user") return false;
      }

      return true;
    }

    // IR-006855 fix
    // bRepaint flag indicates whether to cut the menu items in the Actions menu after the Item has been saved and frame reloaded:
    // if set to true, the Actions menu is purged

    function updateControls(rowId, bRepaint)
    {
      var ids = gridApplet.getSelectedItemIds(';').split(";");
      if (bRepaint == undefined) bRepaint = false;

      if (bTOOLBAR_IS_USED && ids.length > 1)
      {
        setAllControlsEnabled(false);

        setControlEnabled("new", computeCorrectControlState("new"));
        setControlEnabled("copy2clipboard", !isWorkflowTool());
        var pasteFlg = getPasteFlg();
        setControlEnabled("paste", pasteFlg);
        var pasteSpecialFlg = getPasteSpecialFlg();
        setControlEnabled("paste_special", pasteSpecialFlg);

        var purgeFlg = computeCorrectControlState("delete");
        var lockFlg = computeCorrectControlState("lock");
        var unlockFlg = getUnlockFlg();

        if (!purgeFlg || bRepaint) setupMenu4Relationship('remove');
        else setupMenu4Relationship('add');

        setControlEnabled("delete", purgeFlg);
        setControlEnabled("lock", lockFlg);
        setControlEnabled("unlock", unlockFlg);
        setControlEnabled("select_all", true);
        setControlEnabled("search", true);

        return;
      }

      var purgeFlg = computeCorrectControlState("delete");
      var lockFlg = computeCorrectControlState("lock");
      var unlockFlg = getUnlockFlg();
      var promoteFlg = false;

      var rel = item.selectSingleNode('Relationships/Item[@id="' + rowId + '"]');
      if (rel)
      {
        if (bTOOLBAR_IS_USED)
        {
          if (purgeFlg) setupMenu4Relationship('add');
          else setupMenu4Relationship('remove');
        }
        promoteFlg = (!top.aras.isLocked(rel) && !top.aras.isTempEx(rel));
        if (itemTypeName == "Life Cycle State" || itemTypeName == "Transition EMail" || itemTypeName == "Life Cycle Transition" || itemTypeName == "State EMail")
        {
          setControlEnabled("copy2clipboard", false);
          setControlEnabled("paste", false);
          setControlEnabled("paste_special", false);
        }
        else
        {
          setControlEnabled("copy2clipboard", !isWorkflowTool());
          var pasteFlg = getPasteFlg();
          setControlEnabled("paste", pasteFlg);
          var pasteSpecialFlg = getPasteSpecialFlg();
          setControlEnabled("paste_special", pasteSpecialFlg);
        }
      } //if (rel)
      else
      {
        if (bTOOLBAR_IS_USED)
        {
          setAllControlsEnabled(false);
          setControlEnabled("new", computeCorrectControlState("new"));
          setControlEnabled("search", true);
          if (gridApplet.getRowCount() > 0) setControlEnabled("select_all", true);
        }
        setupMenu4Relationship('remove');
        return;
      }


      if (bTOOLBAR_IS_USED)
      {
        setControlEnabled("delete", purgeFlg);
        setControlEnabled("pick_replace", replaceButtonEnabled && purgeFlg);
        setControlEnabled("lock", lockFlg);
        setControlEnabled("unlock", unlockFlg);
        setControlEnabled("promote", promoteFlg);
        setControlEnabled("show_item", computeCorrectControlState("show_item"));
        setControlEnabled("show_relationship", computeCorrectControlState("show_relationship"));

        if (!DescByItemType_Nd)
        {
          setControlEnabled("get_files", false);
          setControlEnabled("checkout", false);
          setControlEnabled("checkin", false);
          setControlEnabled("get_files_related", false);
          setControlEnabled("checkout_related", false);
          setControlEnabled("checkin_related", false);
          return false;
        }

        // ++++++ flags for files from relationship item ++++++
        var isRelationshipIT = true;
        var use_src_accessIT = (top.aras.getItemProperty(DescByItemType_Nd, "use_src_access") == "1");
        var ItemCanBeLockedByUser = top.aras.uiItemCanBeLockedByUser(rel, isRelationshipIT, use_src_accessIT);
        var ItemIsLockedByUser = top.aras.isLockedByUser(rel);

        var get_filesFlg1 = computeCorrectControlState("get_files", rel);
        var checkinFlg1 = undefined;
        var checkoutFlg1 = top.aras.uiIsCheckOutPossible(rel, ItemCanBeLockedByUser, ItemIsLockedByUser, DescByItemType_Nd);
        var fileProps = top.aras.getPropertiesOfTypeFile(DescByItemType_Nd);

        for (var i = 0; i < fileProps.length; i++)
        {
          var propNm = top.aras.getItemProperty(fileProps[i], 'name');
          var file = top.aras.getItemProperty(rel, propNm);
          if (!file) continue;
          file = top.aras.getItemFromServer('File', file, 'filename,locked_by_id').node;
          if (!file)
          {
            get_filesFlg1 = false;
            checkinFlg1 = false;
            break;
          }

          var isLocked = top.aras.isLocked(file);
          var isLockedByUser = top.aras.isLockedByUser(file);

          if (checkinFlg1 == undefined || checkinFlg1 == true) checkinFlg1 = isLockedByUser;
        }

        if (checkinFlg1 == undefined) checkinFlg1 = false;

        setControlEnabled("get_files", get_filesFlg1);
        setControlEnabled("checkout", checkoutFlg1);
        setControlEnabled("checkin", checkinFlg1);

        // ++++++ flags for files from related item ++++++
        var get_filesFlg2 = computeCorrectControlState("get_files_related", rel);
        var checkinFlg2 = undefined;
        var checkoutFlg2 = computeCorrectControlState("checkout_related", rel);

        if (RelatedItemType_Nd)
        {
          var relatedItm = rel.selectSingleNode('related_id/Item');
          if (relatedItm)
          {
            var fileProps = top.aras.getPropertiesOfTypeFile(RelatedItemType_Nd);
            for (var i = 0; i < fileProps.length; i++)
            {
              var propNm = top.aras.getItemProperty(fileProps[i], 'name');
              var file = top.aras.getItemProperty(relatedItm, propNm);
              if (!file) continue;
              file = top.aras.getItemFromServer('File', file, 'filename,locked_by_id').node;
              if (!file)
              {
                get_filesFlg1 = false;
                checkinFlg2 = false;
                break;
              }

              var isLocked = top.aras.isLocked(file);
              var isLockedByUser = top.aras.isLockedByUser(file);

              if (checkinFlg2 == undefined || checkinFlg2 == true) checkinFlg2 = isLockedByUser;
            }
          }
        }

        if (checkinFlg2 == undefined) checkinFlg2 = false;

        setControlEnabled("get_files_related", get_filesFlg2);
        setControlEnabled("checkout_related", checkoutFlg2);
        setControlEnabled("checkin_related", checkinFlg2);
      }
    }

    function mergeWithServerDataIfRequired(relationshipId)
    {
      var relationship = item.selectSingleNode('Relationships/Item[@id="' + relationshipId + '"]');
      if (!relationship)
      {
        top.aras.getItemRelationship(item, RelType_Nm, relationshipId, true);
        return;
      }

      if (relationship.getAttribute("loadedPartialy") == "0") return;

      var relFromServer = top.aras.getItemFromServer(RelType_Nm, relationshipId, undefined, true);
      if (!relFromServer || !relFromServer.node) relFromServer = null;
      if (relFromServer) top.aras.mergeItem(relationship, relFromServer.node);

      relationship.setAttribute("loadedPartialy", "0");
      var related = relationship.selectSingleNode("related_id/Item");
      if (related) related.setAttribute("loadedPartialy", "0");
    }

    function onSelectItem(rowId, col, generateEvent, processAllSelected, loadItemFromServer)
    {
      if (rowId == "header_row") return;

      filterFlg = false;
      if (generateEvent == undefined) generateEvent = true;
      if (processAllSelected == undefined) processAllSelected = true;

      if (processAllSelected)
      {
        var ids = gridApplet.getSelectedItemIds(';').split(";");
        for (var i = 0; i < ids.length; i++)
        {
          if (ids[i] == "") continue;
          if (loadItemFromServer)
          {
            mergeWithServerDataIfRequired(ids[i]);
          }

          var aRel = item.selectSingleNode('Relationships/Item[@id="' + ids[i] + '"]');
          if (!aRel)
          {
            top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.failed_get_item", RelType_Nm));
            return;
          }

          if (top.aras.isPolymorphic(RelatedItemType_Nd))
          {
            var relatedItm = aRel.selectSingleNode('related_id/Item');
            if (relatedItm && top.aras.getItemProperty(RelatedItemType_Nd, 'name') == relatedItm.getAttribute('type'))
            {
              var nativeRelatedITID = top.aras.getItemProperty(relatedItm, 'itemtype');
              if (!nativeRelatedITID)
              {
                top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.required_prop_not_spec_rel_poly_item"));
                return;
              }
              var relatedItemTypeNd = top.aras.getItemTypeForClient(nativeRelatedITID, 'id').node;
              if (!relatedItemTypeNd) return;
              var nativeRelated = top.aras.getItemFromServer(top.aras.getItemProperty(relatedItemTypeNd, 'name'), relatedItm.getAttribute('id'), '*').node;
              if (nativeRelated)
              {
                nativeRelated.setAttribute("loadedPartialy", "0");
                nativeRelated = relatedItm.parentNode.replaceChild(nativeRelated, relatedItm);
              }
            }
          }
        }
      }

      updateControls(rowId);

      var selectedIds = gridApplet.getSelectedItemIds(';');
      if (rowId && selectedIds.indexOf(rowId) > -1)
      {
        currSelCell = gridApplet.cells(rowId, col);
        currSelRowId = rowId;
        currSelCol = col;
      }

      if (generateEvent) handleRowEvent('onselectrow', rowId);
    }

    var FileIT_ID_const = top.aras.getFileItemTypeID();

    var popupMenuRowId = '';
    var popupMenuCol = '';

    function computeCorrectControlState(controlName, arg1)
    {
      /*
      IMPORTANT: If you use arg1 then ALWAYS check if arg1 was actually passed into the
      function because some tools (for example Workflow tool) override the function and
      perhaps don't pass the parameter.
      */

      //debugger;

      if (!item) return false;
      if (!gridApplet) return false;

      var res = false;

      if (controlName == "new")
      {
        var nds = item.selectNodes("Relationships/Item[@type='" + RelType_Nm + "' " +
                               "and (not(@action) or @action!='delete' and @action!='purge')]");
        var currCount = nds.length;

        res = (isEditMode
           && canNewFlag
        //           && (RELATED_IS_DEPENDENT==false) // if CreateRelatedOptions == true and RELATED_IS_DEPENDENT == true
           && (MAX_OCCURS == "" || currCount - MAX_OCCURS < 0));
      }

      else if (controlName == "delete")
      {
        if (!isEditMode) return false;

        var ids = gridApplet.getSelectedItemIds(';').split(";");
        if (ids.length == 0) return false;

        for (var i = 0; i < ids.length; i++)
        {
          var rowId = ids[i];
          var rel = item.selectSingleNode("Relationships/Item[@id='" + rowId + "']");
          if (!rel) return false;

          var relAction = rel.getAttribute("action");
          if (relAction == "purge" || relAction == "delete") return false;
        }

        return true;
      }
      else if (controlName == "show_relationship")
      {
        var ids = gridApplet.getSelectedItemIds(';').split(";");
        if (ids.length != 1) return false;

        var rowId = ids[0];
        var rel = item.selectSingleNode("Relationships/Item[@id='" + rowId + "' and not(@discover_only='1')]");
        if (!rel) return false;

        var relAction = rel.getAttribute("action");
        if (relAction == "purge" || relAction == "delete") return false;

        var formID = top.aras.uiGetFormID4ItemEx(rel, "view");
        return (!!formID);
      }
      else if (controlName == "show_item")
      {
        var r = Boolean(RELATED_IT_NAME);
        if (r)
        {
          var ids = gridApplet.getSelectedItemIds(';').split(";");
          if (ids.length != 1) return false;

          var rowId = ids[0];
          var relatedItm = item.selectSingleNode("Relationships/Item[@id='" + rowId + "']/related_id[not(@discover_only='1')]/Item");
          if (!relatedItm) r = false;
        }
        return r;
      }
      else if (controlName == "remove")
      {
        if (!arg1) return false;
        return replaceToNull && isEditMode && Boolean(RELATED_IT_NAME) && arg1;
      }
      else if (controlName == "lock")
      {
        if (RELATED_IT_NAME == "File")
          return computeCorrectControlState("checkout_related");

        var ids = gridApplet.getSelectedItemIds(';').split(";");
        if (ids.length == 0) return false;

        for (var i = 0; i < ids.length; i++)
        {
          var rowId = ids[i];
          var locked = getLockedStatusStr(rowId);

          if (locked != "") return false;
        }

        return true;
      }
      else if (controlName == "unlock")
      {
        if (!arg1) return false;
        return (top.aras.isLockedByUser(arg1) || top.aras.isLocked(arg1) && loginName.search(/^admin$|^root$/) == 0);
      }
      else if (controlName == "checkout_related")
      {
        if (!RelatedItemType_Nd) return false;

        var ids = gridApplet.getSelectedItemIds(';').split(";");
        if (ids.length != 1) return false;

        var rowId = ids[0];
        var rel = item.selectSingleNode("Relationships/Item[@id='" + rowId + "']");
        if (!rel) return false;
        var relatedItm = rel.selectSingleNode("related_id/Item");
        if (!relatedItm) return false;

        if (RELATED_IT_NAME == "File")
        {
          //check if relationship is locked or can be locked: a part of IR-006444 only for relationships grid.
          var isRelationshipIT = true;
          var use_src_accessIT = (top.aras.getItemProperty(DescByItemType_Nd, "use_src_access") == "1");
          var ItemCanBeLockedByUser = top.aras.uiItemCanBeLockedByUser(rel, isRelationshipIT, use_src_accessIT);
          var ItemIsLockedByUser = top.aras.isLockedByUser(rel);

          if (!ItemCanBeLockedByUser && !ItemIsLockedByUser) return false;
        }

        //common part of logic
        var isRelationshipIT = (top.aras.getItemProperty(RelatedItemType_Nd, "is_relationship") == "1");
        var use_src_accessIT = (top.aras.getItemProperty(RelatedItemType_Nd, "use_src_access") == "1");
        var ItemCanBeLockedByUser = top.aras.uiItemCanBeLockedByUser(relatedItm, isRelationshipIT, use_src_accessIT);
        var ItemIsLockedByUser = top.aras.isLockedByUser(relatedItm);

        return top.aras.uiIsCheckOutPossible(relatedItm, ItemCanBeLockedByUser, ItemIsLockedByUser, RelatedItemType_Nd);
      }
      else if (controlName == "get_files_related")
      {
        if (!RelatedItemType_Nd) return false;

        var ids = gridApplet.getSelectedItemIds(';').split(";");
        if (ids.length != 1) return false;

        var rowId = ids[0];
        var rel = item.selectSingleNode("Relationships/Item[@id='" + rowId + "']");
        if (!rel) return false;
        var relatedItm = rel.selectSingleNode("related_id/Item");
        if (!relatedItm) return false;

        return top.aras.uiIsCopyFilePossible(relatedItm, RelatedItemType_Nd);
      }
      else if (controlName == "get_files")
      {
        if (!RelType_Nd) return false;

        var ids = gridApplet.getSelectedItemIds(';').split(";");
        if (ids.length != 1) return false;

        var rowId = ids[0];
        var rel = item.selectSingleNode("Relationships/Item[@id='" + rowId + "']");
        if (!rel) return false;

        return top.aras.uiIsCopyFilePossible(rel, DescByItemType_Nd);
      }
      else
        return true; //in some places function computeCorrectControlState is called. But it doesn't support some commands.
        //throw new Error(1, top.aras.getResource("", "relationshipsgrid.not_supported_yet", controlName));

      return res;
    }

    function onMenuCreate(rowID, col, p)
    {
      popupMenuRowId = rowID;
      popupMenuCol = col;

      var needToAddSeparator = false;
      var relationshipGrid_PPM = grid.getMenu();

      relationshipGrid_PPM.removeAll();

      function addSeparator()
      {
        if (needToAddSeparator)
        {
          relationshipGrid_PPM.addSeparator();
          needToAddSeparator = false;
        }
      }

      if (rowID == "input_row")
        return false;

      if (rowID == "header_row")
      {
        relationshipGrid_PPM.add("hideCol", top.aras.getResource("", "itemsgrid.cntxt_menu.hide_column"));
        relationshipGrid_PPM.add("addCol", top.aras.getResource("", "itemsgrid.cntxt_menu.insert_column"));
        window.focus();
        return true;
      }
      else
      {
        var selectedRows = gridApplet.getSelectedItemIds(";");
        if (selectedRows.search(rowID) == -1)
          gridApplet.setSelectedRow(rowID, false, false);

        onSelectItem(rowID, false, false, false);
      }

      if (col == -1)
        return false;

      var rel = item.selectSingleNode('Relationships/Item[@id="' + rowID + '" and (not(action) or (action!="delete" and action!="purge"))]');
      if (!rel)
      {
        var aRel = top.aras.getItemRelationship(item, RelType_Nm, rowID, true);
        if (!aRel)
        {
          top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.failed_get_item", RelType_Nm));
          return;
        }
        rel = item.selectSingleNode('Relationships/Item[@id="' + rowID + '" and (not(action) or (action!="delete" and action!="purge"))]');
      }

      if (!rel)
        return false;

      updateControls(rowID);

      var relItm = RelType_Nd.selectSingleNode('related_id/Item');
      var is_dependent = (top.aras.getItemProperty(relItm, 'is_dependent') == '1' ? true : false);

      var related_exists = (rel.selectSingleNode("related_id[.!='' or (./*)]") != null);

      var relatedItm = rel.selectSingleNode('related_id/Item');

      if (RELATED_IT_NAME && hasRelatedItem(rowID))
      {
        if (computeCorrectControlState("show_item"))
          relationshipGrid_PPM.add("show_item", top.aras.getResource("", "relationshipsgrid.view", RELATED_IT_LABEL));
      }

      if (computeCorrectControlState("show_relationship"))
        relationshipGrid_PPM.add('show_relationship', top.aras.getResource("", "relationshipsgrid.view", RelType_Lbl));

      if (propsArr[col].data_source == FileIT_ID_const)
        relationshipGrid_PPM.add('show_file', top.aras.getResource("", "relationshipsgrid.view_file"));

      if (WorkFlowProc != 1)//IR-006609 Error if new workflow process is added to item of item type 
      {
        if (relationshipGrid_PPM.getItemCount() > 0)
          relationshipGrid_PPM.addSeparator();

        if (CONTROLS_STATE_ARRAY["pick_replace"])
        {
          relationshipGrid_PPM.add('pick_replace', top.aras.getResource("", "relationshipsgrid.pickreplace", RELATED_IT_LABEL));
          needToAddSeparator = true;
        }

        if (computeCorrectControlState("remove", related_exists))
        {
          relationshipGrid_PPM.add('remove', top.aras.getResource("", "relationshipsgrid.remove", RELATED_IT_LABEL));
          needToAddSeparator = true;
        }

        addSeparator();

        if (computeCorrectControlState("new"))
        {
          relationshipGrid_PPM.add('new', top.aras.getResource("", "common.new"));
          needToAddSeparator = true;
        }

        if (CONTROLS_STATE_ARRAY["delete"])
        {
          relationshipGrid_PPM.add('delete', top.aras.getResource("", "common.delete"));
          needToAddSeparator = true;
        }

        addSeparator();

        if (itemTypeName != "Life Cycle State" && itemTypeName != "Life Cycle Transition" && itemTypeName != "State EMail" && itemTypeName != "Transition EMail")
        {
          if (!isWorkflowTool())
          {
            relationshipGrid_PPM.add('copy2clipboard', top.aras.getResource("", "common.copy"));
            needToAddSeparator = true;
          }

          if (getPasteFlg())
          {
            relationshipGrid_PPM.add('paste', top.aras.getResource("", "common.paste"));
            needToAddSeparator = true;
          }

          if (getPasteSpecialFlg())
          {
            relationshipGrid_PPM.add('paste_special', top.aras.getResource("", "common.paste_special"));
            needToAddSeparator = true;
          }
        }

        addSeparator();

        if (relatedItm)
        {
          if (computeCorrectControlState("lock"))
          {
            relationshipGrid_PPM.add("lock", top.aras.getResource("", "common.lock"));
            needToAddSeparator = true;
          }

          if (getUnlockFlg())
          {
            relationshipGrid_PPM.add("unlock", top.aras.getResource("", "common.unlock"));
            needToAddSeparator = true;
          }

          addSeparator();
        }

        var isRelationshipIT = true;
        var use_src_accessIT = (top.aras.getItemProperty(DescByItemType_Nd, "use_src_access") == "1");
        var ItemCanBeLockedByUser = top.aras.uiItemCanBeLockedByUser(rel, isRelationshipIT, use_src_accessIT);
        var ItemIsLockedByUser = top.aras.isLockedByUser(rel);

        var fileProps = top.aras.getPropertiesOfTypeFile(DescByItemType_Nd);
        var checkinFlg = undefined;
        var checkoutFlg = top.aras.uiIsCheckOutPossible(rel, ItemCanBeLockedByUser, ItemIsLockedByUser, DescByItemType_Nd);
        var undocheckoutFlg = undefined;
        if (fileProps.length > 0)
        {
          for (var i = 0; i < fileProps.length; i++)
          {
            var propNm = top.aras.getItemProperty(fileProps[i], 'name');
            var file = top.aras.getItemProperty(rel, propNm);
            if (!file) continue;
            file = top.aras.getItemFromServer('File', file, 'filename,locked_by_id').node;
            if (file)
            {
              var isLocked = top.aras.isLockedByUser(file);

              if (checkinFlg == undefined || checkinFlg == true) checkinFlg = isLocked;
              if (undocheckoutFlg == undefined || undocheckoutFlg == true) undocheckoutFlg = isLocked;
            }
          }

          if (computeCorrectControlState("get_files"))
          {
            relationshipGrid_PPM.add('get_files', top.aras.getResource("", "relationshipsgrid.get_copy_of", RelType_Nm));
            needToAddSeparator = true;
          }

          if (checkinFlg)
            relationshipGrid_PPM.add('checkin', top.aras.getResource("", "relationshipsgrid.check_in_for", RelType_Nm));

          if (checkoutFlg)
            relationshipGrid_PPM.add('checkout', top.aras.getResource("", "relationshipsgrid.check_out_for", RelType_Nm));

          if (checkoutFlg)
            relationshipGrid_PPM.add('check_out_to_directory', top.aras.getResource("", "relationshipsgrid.check_out_for_dir", RelType_Nm));

          if (undocheckoutFlg)
            relationshipGrid_PPM.add('undo_check_out', top.aras.getResource("", "relationshipsgrid.undo_check_out_for", RelType_Nm));

          if (needToAddSeparator || checkinFlg || checkoutFlg || undocheckoutFlg)
          {
            relationshipGrid_PPM.addSeparator();
            needToAddSeparator = false;
          }
        }

        checkoutFlg = computeCorrectControlState("checkout_related", rel);
        if (RelatedItemType_Nd && relatedItm)
        {
          fileProps = top.aras.getPropertiesOfTypeFile(RelatedItemType_Nd);
          checkinFlg = undefined;
          undocheckoutFlg = undefined;
          if (fileProps.length > 0)
          {
            for (var i = 0; i < fileProps.length; i++)
            {
              var propNm = top.aras.getItemProperty(fileProps[i], 'name');
              var file = top.aras.getItemProperty(relatedItm, propNm);
              if (!file) continue;
              file = top.aras.getItemFromServer('File', file, 'filename,locked_by_id').node;
              if (file)
              {
                var isLocked = top.aras.isLockedByUser(file);

                if (checkinFlg == undefined || checkinFlg == true) checkinFlg = isLocked;
                if (undocheckoutFlg == undefined || undocheckoutFlg == true) undocheckoutFlg = isLocked;
              }
            }

            if (computeCorrectControlState("get_files_related"))
            {
              relationshipGrid_PPM.add('get_files_related', top.aras.getResource("", "relationshipsgrid.get_copy_of", RELATED_IT_NAME));
              needToAddSeparator = true;
            }

            if (checkinFlg)
              relationshipGrid_PPM.add('checkin_related', top.aras.getResource("", "relationshipsgrid.check_in_for", RELATED_IT_NAME));

            if (checkoutFlg)
            {
              relationshipGrid_PPM.add('checkout_related', top.aras.getResource("", "relationshipsgrid.check_out_for", RELATED_IT_NAME));
              relationshipGrid_PPM.add('check_out_to_directory_related', top.aras.getResource("", "relationshipsgrid.check_out_for_dir", RELATED_IT_NAME));
            }

            if (undocheckoutFlg)
              relationshipGrid_PPM.add('undo_check_out_related', top.aras.getResource("", "relationshipsgrid.undo_check_out_for", RELATED_IT_NAME));

            if (needToAddSeparator || checkinFlg || checkoutFlg || undocheckoutFlg)
              relationshipGrid_PPM.addSeparator();
          }
        }


        var RTActions = relationshipTypeActions[RelType_ID];
        if (RTActions)
        {
          for (var menuEntry in RTActions)
            relationshipGrid_PPM.add(RTActions[menuEntry] + ' ', RTActions[menuEntry] + ' ');
        }

        RTActions = relationshipActions[RelType_ID];
        if (RTActions) for (var menuEntry in RTActions)
          relationshipGrid_PPM.add(RTActions[menuEntry] + '  ', RTActions[menuEntry] + '  ');
      }

      window.focus();
      return !isPopupDisabled;
    }

    function onPopupMenuClick(mi, rowID, col)
    {
      setTimeout('onPopupMenuClick2(\'' + mi + '\',\'' + rowID + '\',' + col + ')', 10);
    }

    function onRelationshipPopupMenuClicked(cmdId, rowId, col)
    {
      return onPopupMenuClick2(cmdId, rowId, col);
    }

    function hideColumn(col)
    {
      gridApplet.SetColumnVisible(col, false, 0);
    }

    function showColumn(col)
    {
      var propsToShow = top.aras.newArray();
      var colOrderArr = gridApplet.getLogicalColumnOrder().split(";");
      for (var i = 0; i < colOrderArr.length; i++)
      {
        if (gridApplet.getColWidth(i) == 0)
        {
          var propLabel = "";
          var propName = "";
          var propWidth = 100;
          var colNm = grid.getColumnName(i);
          if (colNm == "L")
          {
            propLabel = "Locked";
            propWidth = 24;
          }
          else
          {
            var propertyName = colNm.substr(0, colNm.length - 2);
            for (var j = 0; j < DescByVisibleProps.length; j++)
            {
              if (top.aras.getItemProperty(DescByVisibleProps[j], "name") == propertyName)
              {
                propLabel = top.aras.getItemProperty(DescByVisibleProps[j], "label");
                propName = top.aras.getItemProperty(DescByVisibleProps[j], "name");
                if (propLabel == "") propLabel = propertyName;
                var tempWidth = parseInt(top.aras.getItemProperty(DescByVisibleProps[j], "column_width"));
                if (!isNaN(tempWidth)) propWidth = tempWidth;
                break;
              }
            }
            if (RelatedVisibleProps)
            {
              for (var j = 0; j < RelatedVisibleProps.length; j++)
              {
                if (top.aras.getItemProperty(RelatedVisibleProps[j], "name") == propertyName)
                {
                  propLabel = top.aras.getItemProperty(RelatedVisibleProps[j], "label");
                  propName = top.aras.getItemProperty(RelatedVisibleProps[j], "name")
                  if (propLabel == "") propLabel = propertyName;
                  var tempWidth = parseInt(top.aras.getItemProperty(RelatedVisibleProps[j], "column_width"));
                  if (!isNaN(tempWidth)) propWidth = tempWidth;
                  break;
                }
              }
            }
          }
          var propType = colNm.substring(colNm.length - 2, colNm.length);
          propsToShow.push({ colNumber: i, label: propLabel, name: propName, width: propWidth, type: propType });
        }
      }
      
      if (!propsToShow.length)
      {
        top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.no_additional_columns"));
        return;
      }
      
      var params = new Object;
      params.aras = top.aras;
      params.propsToShow = propsToShow;
      var resArr = showModalDialog('SitePreference/showColumnDialog.html', params, 'dialogHeight:500px; dialogWidth:350px; status:0; help:0; resizable:1');
      if (!resArr) return;

      for (var j = 0; j < resArr.length; j++)
      {
        for (var i = 0; i < propsToShow.length; i++)
        {
          if (propsToShow[i].label == resArr[j])
          {
            var showColNumber = propsToShow[i].colNumber;
            var colOrderToSet = gridApplet.GetColumnOrder(col);
            var colOrderNow = gridApplet.GetColumnOrder(showColNumber);
            if (colOrderNow < colOrderToSet) colOrderToSet--;
            gridApplet.SetColumnOrder(showColNumber, colOrderToSet);
            gridApplet.SetColumnVisible(propsToShow[i].colNumber, true, propsToShow[i].width);
            break;
          }
        }
      }
    }

    function populateItemWithLoadedProps(itemToPopulate, loadedPropsItem, show_new_rows)
    {
      var xpath_start = (show_new_rows == true) ? "//Item[@type='" + RelType_Nm + "' and @action='add']" : "//Item[@type='" + RelType_Nm + "']";
      var rships = loadedPropsItem.selectNodes(xpath_start);

      for (var j = 0; j < rships.length; j++)
      {
        var newItem = rships(j);
        if (show_new_rows)
        {
          var xpath = "latest_result/Result";
          var sub_itemToPopulate = itemToPopulate.selectSingleNode(xpath);

          sub_itemToPopulate.appendChild(newItem.cloneNode(true));
          continue;
        }
        var relshId = newItem.getAttribute("id");
        var oldItem = itemToPopulate.selectSingleNode(xpath_start + "[@id='" + relshId + "']");
        if (oldItem)
        {
          mergeProps(oldItem, newItem);
        }
      }

      function mergeProps(oldItem, newItem)
      {
        var newProps = newItem.selectNodes("*[local-name()!='Relationships']");
        for (var i = 0; i < newProps.length; i++)
        {
          var newProp = newProps[i];

          var oldProp = oldItem.selectSingleNode(newProp.baseName);

          if (!oldProp)
            oldItem.appendChild(newProp.cloneNode(true));
          else
          {
            var oldPropItem = oldProp.selectSingleNode("Item");
            if (oldPropItem)
            {
              var newPropItem = newProp.selectSingleNode("Item");
              if (newPropItem)
                mergeProps(oldPropItem, newPropItem);
            }
          }
        }
      }
    }

    function newPopulateRelationshipsGridDom()
    {
      var bodyDom = top.aras.createXMLDocument();
      bodyDom.loadXML("<table><itemID/><relTypeID/><type/><\/table>");
      bodyDom.selectSingleNode("table/itemID").text = itemID;
      bodyDom.selectSingleNode("table/relTypeID").text = RelType_ID;
      bodyDom.selectSingleNode("table/type").text = itemTypeName;
      return bodyDom;
    }

    function onPopupMenuClick2(mi, rowID, col)
    {
      //some action is called
      if ((mi.search(/  $/) != -1) || (mi.search(/ $/) != -1))
      {
        var RTActions = null;

        if (mi.search(/  $/) != -1)
        {
          mi = mi.substring(0, mi.length - 2);
          RTActions = relationshipActions[RelType_ID];
        }
        else if (mi.search(/ $/) != -1)
        {
          mi = mi.substring(0, mi.length - 1);
          RTActions = relationshipTypeActions[RelType_ID];
        }
        else return false;

        if (!RTActions) return false;
        var actID = '';
        for (var menuEntry in RTActions)
        {
          if (mi == RTActions[menuEntry])
          {
            actID = menuEntry;
            break;
          }
        }

        if (!actID) return false;
        var act = top.aras.getItemFromServer('Action', actID, 'name,method(name,method_type,method_code),type,target,location,body,on_complete(name,method_type,method_code),item_query');
        if (!act) return false;

        var actType = act.getProperty('type');
        if (actType == 'itemtype')
          top.aras.invokeAction(act.node, top.aras.getItemProperty(RelType_Nd, 'relationship_id'), '');
        else
        {
          var itemIDs = gridApplet.getSelectedItemIds(";").split(";");
          for (var i in itemIDs)
            top.aras.invokeAction(act.node, top.aras.getItemProperty(RelType_Nd, 'relationship_id'), itemIDs[i]);
        }
        return true;
      }

      processCommand(mi, col);
    }

    function callbackFunction4NewCmd(id, bFlag)
    {
      gridApplet.setSelectedRow(id, false, true);
      onSelectItem(id, 0);
      if (bFlag)
      {
        var show_related = top.aras.getItemProperty(RelType_Nd, "new_show_related");

        if (show_related == "1")
        {//"show_item"
          handleRowEvent('oninsertrow', id);
          showRelatedItemById(id);
          if (parent.updateTabbarState) parent.updateTabbarState(RelType_ID);
          return;
        }
        else
        {
          var column = RELATED_IT_NAME == "" ? 0 : 1;
          for (var i = 0; i < gridApplet.getColumnCount(); i++)
          {
            if (gridApplet.getColumnOrder(i) == column)
            {
              try
              {
                var cell = gridApplet.cells(id, i);
                var isChbox = cell.isCheckbox();
                if (!isChbox) gridApplet.editCell(id, i);
              }
              catch (excep)
              {
                //exception is possible if "new" is clicked many times and very fast
              }

              break;
            }
          } //for
        }
      }

      handleRowEvent('oninsertrow', id);

      updateStatusBar();
      if (parent.updateTabbarState) parent.updateTabbarState(RelType_ID);
    }

    var callback4NewCmd = null;
    var callbackFunction4NewCmd_data_bf = true;

    function systemOnAfterAddRow()
    {
      if (callback4NewCmd)
      {
        //this algorithm relies on that all new rows are last rows in the grid
        //and that there is no chance to miss a row (means that OnXmlLoaded is called "in time")
        var callbackFunction4NewCmd_data_id = gridApplet.getRowsNum();
        if (callbackFunction4NewCmd_data_id > 0)
        {
          callbackFunction4NewCmd_data_id = gridApplet.getRowId(callbackFunction4NewCmd_data_id - 1);
        }

        if (callbackFunction4NewCmd_data_id)
        {
          callback4NewCmd(callbackFunction4NewCmd_data_id, callbackFunction4NewCmd_data_bf);
        }
        callbackFunction4NewCmd_data_bf = true;
      }

      callback4NewCmd = null;
    }

    function processCommand(cmdId, col)
    {
      if (cmdId == "new")
      {
        if (propsArr.length == 0)
        {
          top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.no_visible_props"));
          return;
        }

        if (getSelectedChoiceItem() == PickRelatedOption)
          setTimeout("newRelationship(true)", 1);
        else
          newRelationship(false, (getSelectedChoiceItem() == NoRelatedOption ? null : undefined));
      }
      else if (cmdId == 'pick_replace') setTimeout("changeRelationship(true)", 1);
      else if (cmdId == 'remove') removeRelatedItem();
      else if (cmdId == 'delete') deleteRelationship();
      else if (cmdId == "hideCol") { hideColumn(col); return; }
      else if (cmdId == "addCol") { showColumn(col); return; }
      else if (cmdId == "export2Excel" || cmdId == "export2Word")
      {
        var gridXml = "";
        try { gridXml = grid.getXML(false); } catch (e) { }
        top.aras.export2Office(gridXml, cmdId);
      }
      else if (cmdId == "lock") lockRelatedItem(true);
      else if (cmdId == "unlock") lockRelatedItem(false);
      else if (cmdId == "search")
      {
        onSearchCommand();
      }
      else if (cmdId == 'promote') promoteRelationship();
      else if (cmdId == 'show_item')
      {
        var id = gridApplet.getSelectedId();
        if (!id)
        {
          top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.select_row"));
          return false;
        }
        var res = showRelatedItemById(id);
        if (!res) top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.try_view", RELATED_IT_NAME, RelType_Nm));
        return res;
      }
      else if (cmdId == 'show_relationship')
      {
        var id = gridApplet.getSelectedId();
        if (!id)
        {
          top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.select_row"));
          return false;
        }
        return showRelationshipById(id);
      }
      else if (cmdId == 'show_file') showFileFromCell();
      else if (cmdId == 'getLP') relGetLP();
      else if (cmdId == 'deleteLP') relDeleteLP();
      else if (cmdId == 'promote') relPromote();
      else if (cmdId == 'deleteHistory') relDeleteHistory();

      else if (cmdId == 'checkout') checkout();
      else if (cmdId == 'check_out_to_directory') checkoutToDirectory();
      else if (cmdId == 'undo_check_out') undoCheckout();
      else if (cmdId == 'get_files') getFiles();
      else if (cmdId == 'checkin') checkin();

      else if (cmdId == 'check_out_to_directory_related') checkoutToDirectoryRelated();
      else if (cmdId == 'checkout_related') checkoutRelated();
      else if (cmdId == 'undo_check_out_related') undoCheckoutRelated();
      else if (cmdId == 'get_files_related') getFilesRelated();
      else if (cmdId == 'checkin_related') checkinRelated();
      else if (cmdId == 'copy2clipboard') onCopy2Clipboard();
      else if (cmdId == 'paste') onPaste();
      else if (cmdId == 'paste_special') onPasteSpecial();
      else if (cmdId == 'redline') onRedLinePress();

    } //function processCommand(cmdId)

    function onCopy2Clipboard()
    {
      var itemIDs = gridApplet.getSelectedItemIds(';').split(';');
      var itemArr = new Array();
      var wasSaved = false;
      var tmpItem = item;
      for (var i = 0; i < itemIDs.length; i++)
      {
        var itemID = itemIDs[i];
        var rel = tmpItem.selectSingleNode('Relationships/Item[@id="' + itemID + '"]');
        if (!rel) continue;
        if ((rel.getAttribute("isTemp") || rel.getAttribute("isDirty")) && !wasSaved)
        {
          var res = confirm(top.aras.getResource("", "relationshipsgrid.copy_without_saving"));
          if (res)
          {
            if (top.onSaveCommand) tmpOnSaveCommand = top.onSaveCommand;
            if (top.main && top.main.work && top.main.work.onSaveCommand) tmpOnSaveCommand = top.main.work.onSaveCommand;
            if (!tmpOnSaveCommand) continue;
            tmpOnSaveCommand();
            res = item;
            if (!res || res.getAttribute("isTemp") || res.getAttribute("isDirty")) continue;
            wasSaved = true;
          }
          else continue;
        }

        var clItem = top.aras.copyRelationship(relationshipTypeName, itemID);
        if (clItem) itemArr.push(clItem);
        else top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.failed_get_item_id", itemID));
      }
      top.aras.clipboard.copy(itemArr);
      updateControls(itemIDs[0]);
      if (parent.parent.updateMenuState) parent.parent.updateMenuState();
      if (parent.parent.updateItemsGrid) parent.parent.updateItemsGrid(item);
      var m = null;
      var isEmptyClip = top.aras.clipboard.isEmpty();
      if (top.main && top.main.menu) m = top.main.menu;
      if (top.tearoff_menu) m = top.tearoff_menu;
      if (m) m.setControlEnabled("show_clipboard", !isEmptyClip);
    }

    function onPaste_internal(relsArr, as_is_Flg, as_new_Flg)
    {
      var bShowConfirmDlg = true;

      for (var i in relsArr)
      {
        var clipboardRel = relsArr[i];
        var relNd = top.aras.pasteRelationship(item, clipboardRel, as_is_Flg, as_new_Flg, RelType_Nm, RELATED_IT_NAME, bShowConfirmDlg);

        if (!relNd)
        {
          top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.pasting_failed"));
          return false;
        }

        if (typeof (relNd) == "string" && relNd == "user abort") return false;

        if (bShowConfirmDlg) bShowConfirmDlg = false;
        var relatedItm = relNd.selectSingleNode("related_id/Item");

        callback4NewCmd = callbackFunction4NewCmd;

        callbackFunction4NewCmd_data_bf = false;
        addRow(relNd, relatedItm, false);
      }

      top.aras.AlertSuccess(top.aras.getResource("", "relationshipsgrid.pasting_completed_success"));

      if (parent.parent.updateItemsGrid) parent.parent.updateItemsGrid(item);
      if (parent.parent.updateMenuState) parent.parent.updateMenuState();

      var m = null;
      if (top.main && top.main.menu) m = top.main.menu;
      else if (top.tearoff_menu) m = top.tearoff_menu;
      if (m)
      {
        var isEmptyClip = top.aras.clipboard.isEmpty();
        m.setControlEnabled("show_clipboard", !isEmptyClip);
      }

      return true;
    }

    function onPaste()
    {
      var relsArr = top.aras.clipboard.paste();
      var as_is_Flg = (top.aras.getItemProperty(RelType_Nd, "copy_permissions") == "1");
      var as_new_Flg = (top.aras.getItemProperty(RelType_Nd, "create_related") == "1");

      return onPaste_internal(relsArr, as_is_Flg, as_new_Flg);
    }

    function ReleasedVersionExists()
    {
      var config_id = top.aras.getItemProperty(item, "config_id");

      var itemType = top.aras.getItemTypeForClient(itemTypeName, "name").node;
      var instance_data = top.aras.getItemProperty(itemType, "instance_data");

      if (!config_id)
      {
        return false;
      }
      
      var release_part_aml = 
        "<Item type='" + itemTypeName + "' action='get'>" +
  		"<config_id>" + config_id + "<\/config_id>" + 
		"<generation condition='in'>SELECT MAX(generation) FROM [" + instance_data + "] WHERE config_id='" + config_id + "' AND is_released='1' AND is_current='0'<\/generation>" +
	  "<\/Item>"
   
      var part_res = top.aras.soapSend('ApplyItem', release_part_aml);
      if (part_res.getFaultCode() != 0)
      {
        top.aras.AlertError(part_res.getFaultString(), part_res.getFaultDetails(), part_res.getFaultActor());
        return false;
      }

      if (part_res.isFault())
      {
        return false;
      }

      redlinePrevReleaseDom = part_res;

      return true;
    }

    var redlinePrevReleaseDom;

    function GetLastReleasedInitXML()
    {  
      var part_tmpDom = redlinePrevReleaseDom.results;	

      var result = part_tmpDom.selectSingleNode(top.aras.XPathResult());
      var node = result.selectSingleNode("Item");
      var released_id = node.getAttribute('id');

      
      var aml = "<Item type='" + relationshipTypeName + "' action='get' page='1'>" +
		" <source_id condition='like'>" + released_id + "<\/source_id> " +
		" <\/Item>";

      var res = top.aras.soapSend('ApplyItem', aml);

      if (res.getFaultCode() != 0)
      {
        top.aras.AlertError(res.getFaultString(), res.getFaultDetails(), res.getFaultActor());
        window.close();
      }

      var tmpDom;

      if(res.isFault())
      {
        tmpDom = createEmptyResultDom();
      }
      else
      {
        tmpDom = res.results;
      }

      top.aras.uiPrepareDOM4XSLT(tmpDom, RelType_ID, 'RT_');

      var init_xml = getGenerateRelationshipsGridXML(tmpDom);

      return init_xml;
    }

    function RefreshRedlineView()
    {
      doSkipRedLiningOnXmlLoad = true;
      var config_id = top.aras.getItemProperty(item, "config_id");

      var item_node = top.aras.getItemTypeDictionary(itemTypeName).node;
      var is_versionable = top.aras.getItemProperty(item_node, "is_versionable");

      if (is_versionable == '0' || !is_versionable)
      {
        alert('Type not allow versions');
        return null;
      }

      var init_xml = GetLastReleasedInitXML();

      currentSearchMode.clearSearchCriteria();

      currentSearchMode.setPageNumber(1);
      doSearch();

      if (init_xml == null)
      {
        doSkipRedLiningOnXmlLoad = false;
        return null;
      }

      var noUISearchMode = getSearchModeByName("NoUI");
      if (noUISearchMode)
        searchContainer.showSearchMode(top.aras.getItemProperty(noUISearchMode, "id"));

      setControlEnabled("search_mode", false);

      grid.LoadBaselineXml(init_xml);

      grid.AddAllColumnsToDiffView();
      grid.RemoveColumnFromDiffView("L");

      grid.EnableDiffMode = true;

      doSkipRedLiningOnXmlLoad = false;
      return true;
    }

    function getSearchModeByName(sModeName)
    {
      if (!sModeName)
        return null;

      var modes = top.aras.getSearchModes();
      if (modes)
      {
        for (var i = 0; i < modes.length; i++)
        {
          if (top.aras.getItemProperty(modes[i], "name") == sModeName)
            return modes[i];
        }
      }

      return null;
    }

    var savedSearchAml_bckup = null;
    var savedSearchID_bckup = null;
    function onRedLinePress()
    {        
      var redline_btn = activeToolbar.GetElement('redline');

      if (!isRedlineActive)
      {
        savedSearchID_bckup = currentSearchMode.id;
        savedSearchAml_bckup = currentSearchMode.getAml();

        searchContainer._updateAutoSavedSearch();
        
        isRedlineActive = true;
        redline_btn.SetState(true);

        if (RefreshRedlineView() == null)
        {
          isRedlineActive = false;
          redline_btn.SetState(false);
          return;
        }
        top.aras.setVariable(varName_redlineView, "1");
      }
      else
      {
        top.aras.setVariable(varName_redlineView, "0");
        isRedlineActive = false;
        redline_btn.SetState(false);

        doSkipRedLiningOnXmlLoad = true;

        if(savedSearchID_bckup != null && savedSearchAml_bckup != null)
        {
          currentSearchMode.setAml(savedSearchAml_bckup);
          searchContainer.showSearchMode(savedSearchID_bckup);
        }
        
        setControlEnabled("search_mode", true);
        grid.EnableDiffMode = false;
        doSearch(); 
        doSkipRedLiningOnXmlLoad = false;
      }
    }

    function onPasteSpecial()
    {
      var arguments = new Object();
      arguments.aras = top.aras;
      arguments.itemsArr = new Array(item);
      arguments.srcItemTypeId = top.aras.getItemTypeId(itemTypeName);
      arguments.targetRelationshipTN = RelType_Nm;
      arguments.targetRelatedTN = RELATED_IT_NAME;

      var res = showModalDialog(top.aras.getScriptsURL() + "ClipboardManager.html", arguments, "dialogHeight: 450px; dialogWidth: 700px; status:0; help:0; resizable:0");
      if (!res || !res.ids) return false;

      var clipboardItems = top.aras.clipboard.clItems;
      var relsArr = new Array();
      var as_is_Flg = res.as_is;
      var as_new_Flg = res.as_new;

      for (var i = 0; i < res.ids.length; i++) relsArr.push(clipboardItems[res.ids[i]]);

      return onPaste_internal(relsArr, as_is_Flg, as_new_Flg);
    }

    function onDeletePressed()
    {
      if (!parent.isEditMode) return;
      currSelCell = gridApplet.getSelectedCell();
      if (currSelCell)
      {
        currSelRowId = currSelCell.getRowId();
        currSelCol = currSelCell.getColumnIndex();
      }
      else
        return;

      var p = propsArr[currSelCol];
      var fileItemTypeNd = top.aras.getItemTypeDictionary("File").node;
      var fileItemTypeId = (fileItemTypeNd) ? fileItemTypeNd.getAttribute("id") : "";
      if (p && fileItemTypeId && p.data_type == "item" && p.data_source == fileItemTypeId)
      {
        var currItemNd = item.selectSingleNode("Relationships/Item[@id='" + currSelRowId + "']");
        if (currItemNd && p.DRL == "R") currItemNd = currItemNd.selectSingleNode("related_id/Item");
        var itm2CheckIsLocked = (p.DRL == "R") ? currItemNd : item;
        var doSetNull = (currItemNd && (top.aras.isLockedByUser(itm2CheckIsLocked) || top.aras.isTempEx(currItemNd)));
        doSetNull = (doSetNull && top.aras.getItemProperty(currItemNd, p.name)); //do nothing for empty file prop
        if (doSetNull)
        {
          doSetNull = confirm(top.aras.getResource("", "relationshipsgrid.clear_file_field"));
          gridApplet.requestFocus();
          if (!doSetNull) return;

          var fileNd = currItemNd.selectSingleNode(p.name + "/Item[@type='File']");
          top.aras.setItemProperty(currItemNd, p.name, null);
          setDirtyAttribute(currItemNd); // currItemNd and itm2CheckIsLocked may be different
          setDirtyAttribute(itm2CheckIsLocked);
          currSelCell.setValue("");
          updateControls(currSelRowId);
          if (fileNd && top.aras.isTempEx(fileNd))
            top.aras.removeFromCache(fileNd);
        }
      }
    }

    function onF2Pressed()
    {
      var propDataType = propsArr[currSelCol].data_type;
      if (propDataType == "ml_string")
      {
        showMLDialog();
        return;
      }
      var propSource_ITName = top.aras.getItemTypeName(propsArr[currSelCol].data_source);
      showDialog(propSource_ITName);
    }

    function onKeyPressed(kEv)
    {
      var keyCode = kEv.getKeyCode();
      if (keyCode == 9 || keyCode == 13)
      {//"Tab" or "Enter" pressed
        bTabEnterPressed = true;
      }

      if (keyCode == 113 && (bKEYEDNAME_INPUT_IS_IN_PROGRESS || bML_STRING_INPUT_IS_IN_PROGRESS))
      {// F2 pressed
        onF2Pressed();
      }

      if (keyCode == 46) //"Delete" pressed
      {
        onDeletePressed();
      }

      if (!filterFlg) return true;

      if (keyCode == 13)
      {
        //"Enter" pressed
        filterFlg = false;
        doSearch();
      }
    }

    function onLink(itemTypeName, itemID)
    {
      if (!isEditMode) setTimeout('onLink2("' + itemTypeName + '", "' + itemID + '")');
      return true;
    }

    function onLink2(itemTypeName, itemID)
    {
      if (!isEditMode)
      {
        var itm = top.aras.getItemById(itemTypeName, itemID, 0);
        if (itm) top.aras.uiShowItemEx(itm, undefined, true);
      }
    }

    function onDoubleClick(rowId)
    {
      if (isEditMode) return true;
      if (computeCorrectControlState("show_item") && showRelatedItemById(rowId)) return true;
      else if (computeCorrectControlState("show_relationship")) return showRelationshipById(rowId);
      return false;
    }

    var Synchronizers = new Object();

    function Synchronizer(relID, win, tmout)
    {
      this.relID = relID;
      this.win = win;
      this.rel_LastModifiedOn = -1;
      this.related_LastModifiedOn = -1;

      var relNd = item.selectSingleNode("Relationships/Item[@id='" + this.relID + "']");
      if (!relNd) return;
      var relatedNd = relNd.selectSingleNode("related_id/Item");

      this.relationshipPresence = (relNd != null); //should always be true
      this.relatedPresence = (relatedNd != null); //may vary

      if (tmout == undefined) tmout = 1000;

      Synchronizers[relID] = this;

      this.interval = setInterval('if (Synchronizers["' + relID + '"] && Synchronizers["' + relID + '"].updateData) Synchronizers["' + relID + '"].updateData();', tmout);
    }

    Synchronizer.prototype.getLastModified = function Synchronizer_getLastModified(itemNd)
    {
      var res = -1;

      var attrNm = "LastModifiedOn";
      if (itemNd && itemNd.getAttribute(attrNm)) res = parseInt(itemNd.getAttribute(attrNm));
      if (isNaN(res)) res = -1;

      return res;
    }

    Synchronizer.prototype.stop = function Synchronizer_stop()
    {
      clearInterval(this.interval);
      delete Synchronizers[this.relID];
    }

    Synchronizer.prototype.updateData = function Synchronizer_updateData()
    {
      if (top.aras.isWindowClosed(this.win)) this.stop();

      var relNd = top.aras.getItemRelationship(item, RelType_Nm, this.relID, true);
      var relatedNd = null;

      if (relNd)
      {
        relatedNd = relNd.selectSingleNode("related_id/Item");
        if (!relatedNd)
        {
          var rel_id = relNd.selectSingleNode("related_id[.!='']");
          if (rel_id) // related_id is ID (not an Item)
          {
            var query = '<Item type="' + RelType_Nm + '" id="' + this.relID + '" select="related_id" action="get"/>';
            var res = top.aras.soapSend("ApplyItem", query);
            var new_rel_id = res.results.selectSingleNode(top.aras.XPathResult("/Item/related_id"));
            if (new_rel_id)
            {
              relNd.replaceChild(new_rel_id, rel_id);
              relatedNd = relNd.selectSingleNode("related_id/Item");
            }
          }
        }
      }

      //check if relationship and related are not deleted yet
      if (!relNd && this.relationshipPresence)
      {
        //means that relationship was deleted from it's window
        this.stop();
        gridApplet.setSelectedRow(this.relID, false, false);
        deleteRelationship();
        return;
      }
      if (!relatedNd && this.relatedPresence)
      {
        //means that related was deleted from it's window
        this.stop();
        gridApplet.setSelectedRow(this.relID, false, false);
        removeRelatedItem();
        return;
      }
      //check if relationship and related are not deleted yet

      var rel_LastModifiedOnValue = this.getLastModified(relNd);
      var relalted_LastModifiedOnValue = this.getLastModified(relatedNd);

      var performUpdate = (
      (rel_LastModifiedOnValue > this.rel_LastModifiedOn)
      ||
      (relalted_LastModifiedOnValue > this.related_LastModifiedOn));

      if (performUpdate)
      {
        this.rel_LastModifiedOn = rel_LastModifiedOnValue;
        this.related_LastModifiedOn = relalted_LastModifiedOnValue;

        updateRow(relNd, relatedNd, false, true);
      }
    }

    //+++ to resolve IR-002599: Related item is not unlocked in Relationships Grid
    function relatedItemLockListener(params)
    {
      var itemID = params.itemID;
      var new_ritem = params.itemNd;

      var rels = item.selectNodes("Relationships/Item[@type='" + RelType_Nm + "' and (related_id/Item/@id='" + itemID + "' or related_id='" + itemID + "')]");
      var selectedRows = gridApplet.getSelectedItemIds(";");
      var rowId = "";

      for (var i = 0; i < rels.length; i++)
      {
        var rel = rels[i];
        var relId = rel.getAttribute("id");

        if (selectedRows.indexOf(relId) > -1) rowId = relId;

        if (new_ritem != rel.selectSingleNode('related_id/Item[@id="' + itemID + '"]'))
        {//checking for item rewrite needlessly
          top.aras.setItemProperty(rel, "related_id", new_ritem.cloneNode(true), false);
        }

        updateRow(rel, new_ritem, false, true);
      }

      updateControls(rowId);
    }


    //+++ to resolve IR-005480: New related not visible in grid after selection 
    function ItemSaveListener(params)
    {
      var itemID = params.itemID;
      var new_ritem = params.itemNd;
      var new_ritemID = new_ritem.getAttribute("id");

      var isNewVersion = (new_ritemID != itemID);

      var oldVersionsXPath = "Relationships/Item[@type='" + RelType_Nm + "' and (related_id/Item/@id='" + itemID + "' or related_id='" + itemID + "')]";
      var newVersionsXPath = "Relationships/Item[@type='" + RelType_Nm + "' and (related_id/Item/@id='" + new_ritemID + "' or related_id='" + new_ritemID + "')]";

      var selectedRows = gridApplet.getSelectedItemIds(";");
      var rowId = "";

      if (isNewVersion)
      {
        var rels2NewVers = item.selectNodes(newVersionsXPath);
        //rels2NewVers contain relationships which were updated by common save item logic
        //they already contain correct related item inside. We just need to refresh UI.

        for (var i = 0; i < rels2NewVers.length; i++)
        {
          var rel = rels2NewVers[i];
          var relId = rel.getAttribute("id");

          if (selectedRows.indexOf(relId) > -1) rowId = relId;

          updateRow(rel, new_ritem, false, true);
        }
      }

      var rels = item.selectNodes(oldVersionsXPath);

      for (var i = 0; i < rels.length; i++)
      {
        var rel = rels[i];
        var relId = rel.getAttribute("id");

        if (selectedRows.indexOf(relId) > -1) rowId = relId;

        var callUpdateRow = false;
        if (isNewVersion)
        {
          var replaceWithNewVersion = false;

          if (top.aras.isTempEx(rel)) replaceWithNewVersion = true;
          else
          {
            var req = "<Item type='" + RelType_Nm + "' select='related_id' action='get' related_expand='0' id='" + relId + "'/>";
            var res = top.aras.soapSend("ApplyItem", req);

            if (res.getFaultCode() == 0)
            {
              var related_idNd = res.results.selectSingleNode(top.aras.XPathResult("/Item/related_id"));
              if (related_idNd) replaceWithNewVersion = (new_ritemID == related_idNd.text);
            }
          }

          if (replaceWithNewVersion)
          {
            top.aras.setItemProperty(rel, "related_id", new_ritem.cloneNode(true)); //updateRow updates only UI
            callUpdateRow = true;
          }
        }
        else
        {
          callUpdateRow = true;
        }

        if (callUpdateRow) updateRow(rel, new_ritem, false, true);
      }

      //second parameter enables Actions menu purging after the Relationship grid has been reloaded
      updateControls(rowId, true);

      var ItemName = top.aras.getItemProperty(item, "name");
      if (ItemName == 'ItemType' && itemTypeName == 'ItemType')
        onInitialize();
    }

    top.aras.registerEventHandler("ItemLock", window, relatedItemLockListener);
    top.aras.registerEventHandler("ItemSave", window, ItemSaveListener);
    //--- to resolve IR-002599: Related item is not unlocked in Relationships Grid

    function showRelatedItemById(relID)
    {
      var relShipItm = item.selectSingleNode('Relationships/Item[@id="' + relID + '"]');

      var ritem = item.selectSingleNode('Relationships/Item[@id="' + relID + '"]/related_id[not(@discover_only="1")]/Item');
      if (!ritem || ritem.getAttribute("loadedPartialy") != "0")
        mergeWithServerDataIfRequired(relID);

      ritem = item.selectSingleNode('Relationships/Item[@id="' + relID + '"]/related_id[not(@discover_only="1")]/Item')
      if (!ritem) return false;

      var ritemID = ritem.getAttribute('id');
      var win = top.aras.uiFindWindowEx(ritemID);
      if (win && (win.fromRelationships == undefined || win.fromRelationships != itemID))
      {
        top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.already_open"));
        return true;
      }

      top.aras.uiShowItemEx(ritem, 'tab view', true)

      win = top.aras.uiFindWindowEx(ritemID);
      if (win)
      {
        win.fromRelationships = itemID;
        new Synchronizer(relID, win);
      }

      return true;
    }

    function showRelationshipById(relID)
    {
      var rel = item.selectSingleNode('Relationships/Item[@id="' + relID + '" and not(@discover_only="1")]');
      if (!rel) return false;

      mergeWithServerDataIfRequired(relID);

      var win = top.aras.uiFindWindowEx(relID);
      if (win && (win.fromRelationships == undefined || win.fromRelationships != itemID))
      {
        top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.already_open"));
        return true;
      }

      top.aras.uiShowItemEx(rel, 'tab view', true);

      win = top.aras.uiFindWindowEx(relID);
      if (win)
      {
        win.fromRelationships = itemID;
        new Synchronizer(relID, win);
      }

      return true;
    }

    //+++++ file processing
    function showFileFromCell()
    {
      var fileId = findFileId();
      if (fileId) top.aras.uiShowItem('File', fileId);
    }

    function findFileId()
    { //with popupMenuRowId, popupMenuCol:
      var rel = item.selectSingleNode('Relationships/Item[@id="' + popupMenuRowId + '" and (not(action) or (action!="delete" and action!="purge"))]');
      if (!rel) return '';

      var prop = propsArr[popupMenuCol];
      if (prop.data_source != FileIT_ID_const) return '';

      var itm = null;
      var propDRL = prop.DRL;
      if (propDRL == 'R')
      {
        itm = rel.selectSingleNode('related_id/Item');
        if (!itm) return '';
      }
      else if (propDRL == 'D') itm = rel;

      return top.aras.getItemProperty(itm, prop.name);
    }
    //----- file propcessing


    function showDialog2(relatedIT_ID, pick_replace)
    {
      if (!relatedIT_ID) return false;

      function turnSpecialCodeOff()
      {
        callbackFunction4NewCmd_data_bf = false; //do not auto edit first cell in new row
      }

      function addRelationship(relatedItm)
      {
        turnSpecialCodeOff();

        if (!relatedItm) return false;
        newRelationship(false, relatedItm);
      }

      function addRelationshipHandler(result, type_of_action)
      {
        if (type_of_action == "doubleclick")
        {
          if (result.item)
          {
            var type = top.aras.getItemTypeName(relatedIT_ID);
            var itmID = result.item.getAttribute("id");
            addRelationship(top.aras.getItemById(type, itmID, 0));
          }
          return false;
        }
        else return true;
      }

      var param = new Object();
      param.aras = top.aras;              // dialogArguments[0]
      param.itemtypeID = relatedIT_ID;    // dialogArguments[1]
      param.itemContext = item;           // dialogArguments[2]
      if (pick_replace)
      {
        param.itemSelectedID = currSelRowId;     // dialogArguments[3]
        param.handler = null;  // dialogArguments[4]
        param.multiselect = false;

        mergeWithServerDataIfRequired(currSelRowId);
      }
      else
      {
        param.itemSelectedID = itemID;    // dialogArguments[3]
        param.handler = addRelationshipHandler;  // dialogArguments[4]
        param.multiselect = true;
      }
      param.argType = "object";
      param.sourceItemTypeName = (DescByItemType_Nd) ? top.aras.getItemProperty(DescByItemType_Nd, "name") : "";
      param.sourcePropertyName = "related_id";

      var res = showModalDialog('searchDialog.html', param, 'dialogHeight:450px; dialogWidth:700px; status:0; help:0; resizable:1');
      if (!res) return;

      var type = top.aras.getItemTypeName(relatedIT_ID);

      if (pick_replace)
      {
        res = res.item;
        if (!res)
        {
          if (replaceToNull) removeRelatedItem();
          else
          {
            top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.related_item_cannot_null"));
            setTimeout("changeRelationship(true);", 1);
          }
          return;
        }

        changeRelationship(false, res);
      }
      else
      {
        for (var i = 0; i < res.length; i++)
        {
          var itmID = res[i];
          itm = top.aras.getItemById(type, itmID, 0);
          if (!itm) continue;
          addRelationship(itm);
        }
      }
    }

    function newRelationship(showSearchDialog, relatedNd)
    {
      if (showSearchDialog == undefined) showSearchDialog = false;

      var relatedIT_ID = top.aras.getItemProperty(RelType_Nd, 'related_id');
      if (showSearchDialog)
      {
        if (!relatedIT_ID)
        {
          top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.related_it_not_spec", RelType_Nm));
          return false;
        }

        //showDialog2 will indirectly call newRelationship again with showSearchDialog == false
        var res = showDialog2(relatedIT_ID);
        return res;
      }

      //debugger;
      var relNd = top.aras.newRelationship(RelType_ID, item, false, window, relatedNd);

      top.focus();
      if (!relNd) return false;

      callback4NewCmd = callbackFunction4NewCmd;
      window.focus();

      var selectedChoiceOption = getSelectedChoiceItem();
      if (selectedChoiceOption == NoRelatedOption)
      {
        var rel_id = relNd.selectSingleNode("related_id");
        if (rel_id)
        {
          rel_item = rel_id.selectSingleNode('Item');
          if (rel_item) rel_id.removeChild(rel_item);
        }
        else rel_id = relNd.appendChild(relNd.ownerDocument.createElement("related_id"));
        rel_id.setAttribute("is_null", "1");
      }
      else if (selectedChoiceOption == CreateRelatedOption)
      {
        if (RelType_Nm == "View")
        {
          //The new form must be a copy of an existing which is:
          //1. associated to the root level class (or where the class is null)
          //2. where the Function is equal to "Default"
          //3. the identity is equal to "World"

          var formNode = relNd.selectSingleNode("related_id/Item[@type='Form']");
          if (formNode)
          {
            var class_structure = top.aras.getItemProperty(item, "class_structure");
            var addCond = "";
            if (class_structure != "")
            {
              var structDom = top.aras.createXMLDocument();
              structDom.loadXML(class_structure);
              var tmpNd = structDom.selectSingleNode("/*");
              if (tmpNd) addCond = " or form_classification='/" + tmpNd.getAttribute("name") + "'";
            }

            var formToCopy = item.selectSingleNode(
          "Relationships/Item[@type='View'][role/@keyed_name='World'][type='default']" +
          "[not(form_classification) or form_classification=''" + addCond + "]/related_id/Item[@type='Form']");

            if (formToCopy)
            {
              formToCopy = top.aras.getItemById("Form", formToCopy.getAttribute("id"), 1, "Body", "id");
              if (formToCopy)
              {
                var bodyToCopy = formToCopy.selectSingleNode("Relationships/Item[@type='Body']");
                if (bodyToCopy)
                {
                  var newBodyNd = top.aras.copyItemEx(bodyToCopy, "copy", false);
                  if (newBodyNd)
                  {
                    var nodesToDelete = newBodyNd.selectNodes(".//source_id");
                    nodesToDelete.removeAll();

                    var oldBodyNd = formNode.selectSingleNode("Relationships/Item[@type='Body']");
                    oldBodyNd.parentNode.replaceChild(newBodyNd, oldBodyNd);
                  }
                }
              }
            }
          }
        } //if (RelType_Nm == "View")
      }

      relNd = item.selectSingleNode('Relationships').appendChild(relNd);

      if (!top.aras.isTempEx(item)) setDirtyAttribute(item);

      var relatedItm = relNd.selectSingleNode('related_id/Item');
      if (relatedItm)
      {
        if (top.aras.isPolymorphic(RelatedItemType_Nd) && !top.aras.getItemProperty(relatedItm, 'itemtype'))
        {
          var typeId = relatedItm.getAttribute('typeId');
          if (!typeId || typeId === '')
          {
            var typeName = relatedItm.getAttribute('type');
            typeId = top.aras.getItemTypeId(typeName);
          }
          top.aras.setItemProperty(relatedItm, 'itemtype', typeId);
        }
      }
      addRow(relNd, relatedItm, false);
    }

    function changeRelationship(showSearchDialog, relatedNd)
    {
      if (showSearchDialog == undefined) showSearchDialog = true;

      var relatedIT_ID = top.aras.getItemProperty(RelType_Nd, 'related_id');
      if (showSearchDialog)
      {
        if (!relatedIT_ID)
        {
          top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.related_it_not_spec", RelType_Nm));
          return false;
        }
        else return showDialog2(relatedIT_ID, true);
      }

      if (!relatedNd)
      {
        top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.cant_change_relship"));
        return;
      }

      top.focus();

      var relId = gridApplet.getSelectedId();
      if (!relId)
      {
        top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.select_relship"));
        return false;
      }

      var relNd = item.selectSingleNode('Relationships/Item[@id="' + relId + '"]');
      if (!relNd)
      {
        top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.no_relship_item_found"));
        return;
      }

      var relatedIdNode = relNd.selectSingleNode('related_id');
      if (relatedIdNode) relNd.removeChild(relatedIdNode);

      relatedIdNode = relNd.appendChild(relNd.ownerDocument.createElement('related_id'));

      var related_id = top.aras.getItemProperty(relatedNd, 'id');

      relatedIdNode.text = "";
      if (item == relatedNd) //case of simple recursion
      {
        relatedNd = item.cloneNode(true);
        relatedNd.setAttribute("action", "skip");
        var relationshipsNd = relatedNd.selectSingleNode("Relationships");
        if (relationshipsNd)
          relatedNd.removeChild(relationshipsNd);
        relationshipsNd = null;
      }
      relatedIdNode.appendChild(relatedNd);

      if (null != relatedIdNode.getAttribute('is_null'))
        relatedIdNode.setAttribute('is_null', '0');

      if (null == relNd.getAttribute('action'))
        relNd.setAttribute('action', 'update');

      if (top.aras.isPolymorphic(RelatedItemType_Nd) && relatedNd && !top.aras.getItemProperty(relatedNd, 'itemtype'))
        top.aras.setItemProperty(relatedNd, 'itemtype', relatedNd.getAttribute('typeId'));

      if (!top.aras.isTempID(itemID)) setDirtyAttribute(item);

      updateRow(relNd, relatedNd, false, true);
      updateControls(relId);

      updateStatusBar();
      if (parent.updateTabbarState) parent.updateTabbarState(RelType_ID);
    }

    function removeRelatedItem()
    {
      var relId = gridApplet.getSelectedId();
      if (!relId)
      {
        top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.select_relship"));
        return false;
      }

      var relNd = item.selectSingleNode('Relationships/Item[@id="' + relId + '"]');
      if (!relNd) return;

      var rel_id = relNd.selectSingleNode('related_id');
      if (rel_id)
      {
        rel_item = rel_id.selectSingleNode('Item');
        if (rel_item) rel_id.removeChild(rel_item);
      }
      else rel_id = relNd.appendChild(relNd.ownerDocument.createElement("related_id"));
      rel_id.setAttribute("is_null", "1");

      if (null == relNd.getAttribute('action'))
        relNd.setAttribute('action', 'update');

      updateRow(relNd, null, false);

      updateStatusBar();
      if (parent.updateTabbarState) parent.updateTabbarState(RelType_ID);
    }

    function deleteRelationship()
    {
      var ids = gridApplet.getSelectedItemIds(';').split(";");
      if (ids.length == 0)
      {
        top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.select_relship"));
        return false;
      }

      for (var j = 0; j < ids.length; j++)
      {
        var relId = ids[j];
        if (!relId)
        {
          top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.select_relship"));
          return false;
        }

        var clItem = top.aras.clipboard.getItem(relId)
        if (clItem)
        {
          var res = confirm(top.aras.getResource("", "relationshipsgrid.delete_from_clipboard_not_future_pasting"));
          if (!res) continue;
        }

        var rel = item.selectSingleNode('Relationships/Item[@id="' + relId + '"]');
        if (!rel)
        {
          gridApplet.deleteRow(relId);
          return false;
        }


        if (!handleRowEvent('ondeleterow', relId)) return false;

        var act = rel.getAttribute("action");
        var deleteRowFromGrid = false;
        if (act == "add")
        {
          var currSelCell = gridApplet.getSelectedCell();
          if (currSelCell && currSelCell.IsEdited()) currSelCell.setValue("");
          rel.parentNode.removeChild(rel);

          deleteRowFromGrid = true;
        }
        else
        {
          rel.setAttribute("action", "delete");
          if (!top.aras.isTempID(itemID)) setDirtyAttribute(item);

          if (isRedlineActive)
          {
            deleteRowFromGrid = true;
          }
          else
          {
            deleteRowFromGrid = false;
          }
        }

        if (deleteRowFromGrid)
        {
          gridApplet.deleteRow(relId);
          updateStatusBar();
          updateToolbar();
          updateControls(relId);
        }
        else
        {
          for (var i = 0; i < gridApplet.getColumnCount(); i++)
          {
            var cell = gridApplet.cells(relId, i);
            cell.setFont(deletedFont_const);
            cell.setTextColor(deletedTextColor_const);
          }

          onSelectItem(relId, false, false, false);
        }

        deletedRows[relId] = 1;
        if (parent.updateTabbarState) parent.updateTabbarState(RelType_ID);
      }
    }

    function lockRelatedItem(b)
    {
      var ids = gridApplet.getSelectedItemIds(';').split(";");
      if (ids.length == 0 || gridApplet.getSelectedItemIds(";") == "")
      {
        top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.select_relship"));
        return false;
      }

      var res = true;
      var rowId = "";
      for (var i = 0; i < ids.length; i++)
      {
        rowId = ids[i];
        var rel = item.selectSingleNode('Relationships/Item[@id="' + rowId + '"]');
        var relatedNd = rel.selectSingleNode('related_id/Item');
        if (!relatedNd)
        {
          top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.related_item_not_found"));
          return false;
        }

        var resNd = null;
        if (b) resNd = top.aras.lockItemEx(relatedNd);
        else resNd = top.aras.unlockItemEx(relatedNd);

        if (!resNd) res = false;
      }

      //update row is not called here because it will be called from relatedItemLockListener

      //if (rowId) updateControls(rowId);

      return res;
    }

    function promoteRelationship()
    {
      var relId = gridApplet.getSelectedId();
      if (!relId)
      {
        top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.select_relship"));
        return false;
      }

      var rel = item.selectSingleNode('Relationships/Item[@id="' + relId + '"]');
      if (!rel) return false;

      var param = new Object();
      param.item = rel;
      param.aras = top.aras;

      var res = showModalDialog('promoteDialog.html', param, 'dialogHeight:300px;dialogWidth:400px;status:0;help:0;resizable:1;');
      if (typeof (res) == 'string' && res == 'null')
      {
        rel.parentNode.removeChild(rel);
        gridApplet.deleteRow(relId);
        updateStatusBar();
        return;
      }
      if (!res) return true;

      updateRow(res, res.selectSingleNode('related_id/Item'), false, true);
    }


    function checkout4Reationship(checkout_dir)
    {
      var rowID = gridApplet.getSelectedId();
      if (!rowID) return;

      var rel = item.selectSingleNode('Relationships/Item[@id="' + rowID + '"]');
      if (!rel) return false;

      if (checkout_dir == undefined)
      {
        checkout_dir = top.aras.vault.selectFolder();
        if (!checkout_dir) return true;
      }

      var use_src_access = (top.aras.getItemProperty(DescByItemType_Nd, "use_src_access") == "1");
      if (use_src_access) top.aras.checkoutFiles(rel, checkout_dir);
      else
      {
        if (!top.aras.isLocked(rel)) top.aras.lockItemEx(rel, checkout_dir, false);
        else top.aras.checkoutFiles(rel, checkout_dir);
      }

      updateRow(rel, rel.selectSingleNode('related_id/Item'), false, true);
      updateControls(rowID);

      if (!isEditMode && use_src_access && parent.parent.onLockCommand) parent.parent.onLockCommand();

      top.aras.AlertSuccess(top.aras.getResource("", "relationshipsgrid.ready"));
      return true;
    }

    function checkout()
    {
      return checkout4Reationship(top.aras.getWorkingDir(true, window));
    }

    function checkoutToDirectory()
    {
      return checkout4Reationship();
    }

    function undoCheckout()
    {
      var rowID = gridApplet.getSelectedId();
      if (!rowID) return;
      var rel = item.selectSingleNode('Relationships/Item[@id="' + rowID + '"]');
      if (!rel) return false;
      top.aras.undoCheckOut(rel);

      updateRow(rel, rel.selectSingleNode('related_id/Item'), false, true);
      updateControls(rowID);
      top.aras.AlertSuccess(top.aras.getResource("", "relationshipsgrid.ready"));
      return true;
    }

    function getFiles()
    {
      var rowID = gridApplet.getSelectedId();
      if (!rowID) return;
      var rel = item.selectSingleNode('Relationships/Item[@id="' + rowID + '"]');
      if (!rel) return false;
      top.aras.downloadItemFiles(rel, top.aras.getWorkingDir(true, window));
      top.aras.AlertSuccess(top.aras.getResource("", "relationshipsgrid.ready"));
      return true;
    }

    function checkin_commonPart(IT_nd, itm)
    {
      var fileProps = top.aras.getPropertiesOfTypeFile(IT_nd);
      for (var j = 0; j < fileProps.length; j++)
      {
        var propNm = top.aras.getItemProperty(fileProps[j], "name");
        var file = itm.selectSingleNode(propNm + "/Item");
        if (!file)
        {
          file = top.aras.getItemProperty(itm, propNm);
          if (file) file = top.aras.getItemFromServer("File", file, "locked_by_id,filename,checkedout_path").node;
        }

        if (file) top.aras.checkinFile(file, window);
      }
    }

    function checkin()
    {
      if (!DescByItemType_Nd) return false;

      var rowID = gridApplet.getSelectedId();
      if (!rowID) return;
      var rel = item.selectSingleNode('Relationships/Item[@id="' + rowID + '"]');
      if (!rel) return false;

      var isVersionableIT = (top.aras.getItemProperty(DescByItemType_Nd, "is_versionable") == "1");
      if (isVersionableIT && top.aras.getItemProperty(rel, 'new_version') != '1')
      {
        if (confirm(top.aras.getResource("", "relationshipsgrid.need_save", RelType_Nm, top.aras.getKeyedNameEx(rel))))
        {
          if (!top.aras.saveItemEx(rel)) return false;
        }
        else return;
      }
      else checkin_commonPart(DescByItemType_Nd, rel);

      rel = item.selectSingleNode('Relationships/Item[@id="' + rowID + '"]');

      updateRow(rel, rel.selectSingleNode('related_id/Item'), false, true);
      updateControls(rowID);

      top.aras.AlertSuccess(top.aras.getResource("", "relationshipsgrid.ready"));
      return true;
    }


    function checkout4Related(checkout_dir)
    {
      var rowID = gridApplet.getSelectedId();
      if (!rowID) return;

      var rel = item.selectSingleNode('Relationships/Item[@id="' + rowID + '"]');
      if (!rel) return false;
      var itm = rel.selectSingleNode('related_id/Item');
      if (!itm) return false;

      if (checkout_dir == undefined)
      {
        checkout_dir = top.aras.vault.selectFolder();
        if (!checkout_dir) return true;
      }

      if (!top.aras.isLocked(itm))
      {
        var res = top.aras.lockItemEx(itm, checkout_dir, false);
      }
      else top.aras.checkoutFiles(itm, checkout_dir);

      updateRow(rel, rel.selectSingleNode('related_id/Item'), false, true);
      updateControls(rowID);

      top.aras.AlertSuccess(top.aras.getResource("", "relationshipsgrid.ready"));
      return true;
    }

    function checkoutRelated()
    {
      return checkout4Related(top.aras.getWorkingDir(true, window));
    }

    function checkoutToDirectoryRelated()
    {
      return checkout4Related();
    }

    function undoCheckoutRelated()
    {
      var rowID = gridApplet.getSelectedId();
      if (!rowID) return;
      var rel = item.selectSingleNode('Relationships/Item[@id="' + rowID + '"]');
      if (!rel) return false;
      var itm = rel.selectSingleNode('related_id/Item');
      if (!itm) return false;

      var res = top.aras.undoCheckOut(itm);
      if (RELATED_IT_NAME == "File" && res) itm = res;

      updateRow(rel, itm, false, true);
      updateControls(rowID);
      top.aras.AlertSuccess(top.aras.getResource("", "relationshipsgrid.ready"));
      return true;
    }

    function getFilesRelated()
    {
      var rowID = gridApplet.getSelectedId();
      if (!rowID) return;
      var itm = item.selectSingleNode('Relationships/Item[@id="' + rowID + '"]/related_id/Item');
      if (!itm) return false;
      top.aras.downloadItemFiles(itm, top.aras.getWorkingDir(true, window));
      top.aras.AlertSuccess(top.aras.getResource("", "relationshipsgrid.ready"));
      return true;
    }

    function checkinRelated()
    {
      var rowID = gridApplet.getSelectedId();
      if (!rowID) return;

      var rel = item.selectSingleNode('Relationships/Item[@id="' + rowID + '"]');
      if (!rel) return false;
      var itm = rel.selectSingleNode('related_id/Item');
      if (!itm) return false;

      if (!RelatedItemType_Nd) return false;

      var isVersionableIT = (top.aras.getItemProperty(RelatedItemType_Nd, 'is_versionable') == '1');
      if (isVersionableIT && top.aras.getItemProperty(itm, 'new_version') != '1')
      {
        if (confirm(RELATED_IT_NAME + " \"" + top.aras.getKeyedNameEx(itm) + "\" needs to be saved. Save it ?"))
        {
          if (RELATED_IT_NAME=="File") top.aras.saveUICommandHistoryIfNeed("File", itm.getAttribute("id"), "checkin", new Array(top.aras.getItemProperty(itm, "filename")));
          if (!top.aras.saveItemEx(itm)) return false;
        }
        else return;
      }
      else checkin_commonPart(RelatedItemType_Nd, itm);

      rel = item.selectSingleNode('Relationships/Item[@id="' + rowID + '"]');

      updateRow(rel, rel.selectSingleNode('related_id/Item'));
      updateControls(rowID);

      top.aras.AlertSuccess(top.aras.getResource("", "relationshipsgrid.ready"));
      return true;
    }

    function emptyGrid()
    {
      for (var i = gridApplet.getRowsNum() - 1; i >= 0; i--)
      {
        gridApplet.deleteRow(gridApplet.getRowId(i));
      }
    }


    var deletedRows = new Object();

    function updateAfterSave()
    {
      if (itemTypeName == 'ItemType')
      {
        item = top.aras.getItemTypeDictionary(top.aras.getItemTypeName(itemID)).node;
        //    item = top.aras.getItemById(itemTypeName, itemID, 1, 'Property');
      }
      else
      {
        item = top.aras.getItemById(itemTypeName, itemID, 0);
      }

      for (var rowId in deletedRows)
      {
        delete deletedRows[rowId];
      }
    }

    function syncWithClient(resDom)
    {
      var res = resDom.selectSingleNode(top.aras.XPathResult());
      var xpath_start = "Relationships/Item[@type='" + RelType_Nm + "' and (";

      if (!item) return; //this is possible in Workflow Map Editor. IR-004193

      var itms = item.selectNodes(xpath_start + " (@action='delete' or @action='purge') or (@isTemp='1' or @isDirty='1'))]");

      for (var i = 0; i < itms.length; i++)
      {
        var itm = itms[i];
        var itm_id = itm.getAttribute("id");
        var item_isTemp = top.aras.isTempEx(itm);

        if (!item_isTemp)
        {
          var bad_itm = res.selectSingleNode("Item[@id='" + itm_id + "']");
          if (bad_itm) res.replaceChild(itm.cloneNode(true), bad_itm);
          else
          {
            if (top.aras.isDirtyEx(itm))
              res.appendChild(itm.cloneNode(true));
          }
        }
        else res.appendChild(itm.cloneNode(true));
      }

      if (isRedlineActive)
      {
        var relsToRemoveNds = res.selectNodes("Item[@type='" + RelType_Nm + "' and (@action='delete' or @action='purge')]");
        for (var i = 0, L = relsToRemoveNds.length; i < L; i++)
        {
          var relsToRemoveNd = relsToRemoveNds[i];
          res.removeChild(relsToRemoveNd);
        }
      }


      if (RELATED_IT_NAME != "")
      {
        itms = res.selectNodes("Item[@type='" + RelType_Nm + "' " +
    " and related_id and not(related_id/Item) and related_id != '' " +
    "]");

        for (var i = 0; i < itms.length; i++)
        {
          var itm = itms[i];
          var related_id = top.aras.getItemProperty(itm, "related_id");

          var rItm = top.aras.getItemById(RELATED_IT_NAME, related_id, 0);
          if (!rItm) continue;
          var rItmKN = top.aras.getKeyedNameEx(rItm);

          var related_id_nd = itm.selectSingleNode("related_id");
          related_id_nd.text = "";
          related_id_nd.appendChild(rItm.cloneNode(true));
          related_id_nd.setAttribute("keyed_name", rItmKN);
        }
      }
    }

    function generateXML4Relationship(relationshipNd)
    {
      //returns grid ready xml document with information about just one row
      var tmpDom = createEmptyResultDom();
      var res = tmpDom.selectSingleNode(top.aras.XPathResult());
      res.appendChild(relationshipNd.cloneNode(true));

      top.aras.uiPrepareDOM4XSLT(tmpDom, RelType_ID, 'RT_');

      var grid_xml = getGenerateRelationshipsGridXML(tmpDom);
      tmpDom.loadXML(grid_xml);

      var nds = tmpDom.selectNodes("/table/*[local-name(.)!='tr']");
      var tableNd = tmpDom.documentElement;
      for (var i = 0; i < nds.length; i++)
      {
        var nd = nds[i];
        tableNd.removeChild(nd);
      }

      return tmpDom;
    }

    function system_UpdateGridCell(cell, tdNd)
    {
      var td_textColor = tdNd.getAttribute("textColor");
      var td_link = tdNd.getAttribute("link");
      var td_bgColor = tdNd.getAttribute("bgColor");
      var td_font = tdNd.getAttribute("font");
      var td_value = tdNd.text;

      if (td_textColor) try { cell.setTextColor(td_textColor); } catch (excep) { }
      if (td_link) cell.setLink(td_link);
      if (td_bgColor) try { cell.setBgColor(td_bgColor); } catch (excep) { }
      if (td_font) cell.setFont(td_font);
      cell.setValue(td_value);
    }

    function updateRow(relNd, relatedNd, markDirty, onlyUI, checkRelated)
    {
      /*
      designed to update grid UI only
    
      if (top.aras.isPolymorphic(RelatedItemType_Nd) && relatedNd && !top.aras.getItemProperty(relatedNd, 'itemtype'))
      {
        var typeId = relatedNd.getAttribute('typeId');
        top.aras.setItemProperty(relatedNd, 'itemtype', typeId);
      }*/

      if (!relNd) return false;
      if (checkRelated === undefined) checkRelated = true;

      var relId = relNd.getAttribute('id');

      if (checkRelated && relatedNd)
      {
        var related_id = relatedNd.getAttribute("id");

        var rels2update =
      item.selectNodes(
        "Relationships/Item" +
        "[@type='" + RelType_Nm + "' " +
        "and (related_id='" + related_id + "' or related_id/Item/@id='" + related_id + "') " +
        "and @id!='" + relId + "']"
      );

        for (var i = 0; i < rels2update.length; i++)
        {
          var aRel = rels2update[i];
          var relatedId = relatedNd.getAttribute('id');
          //checking for item rewrite needlessly
          if (relatedNd != aRel.selectSingleNode('related_id/Item[@id="' + relatedId + '"]'))
            top.aras.setItemProperty(aRel, "related_id", relatedNd.cloneNode(true), false);
          updateRow(aRel, relatedNd, markDirty, onlyUI, false);
        }
      }

      var tmpDom = top.aras.createXMLDocument();
      var tmpNd = relNd.cloneNode(true);
      var tmpNd2 = tmpNd.selectSingleNode("related_id");
      if (tmpNd2) tmpNd.removeChild(tmpNd2);
      tmpNd2 = tmpNd.appendChild(tmpDom.createElement("related_id"));
      if (relatedNd) tmpNd2.appendChild(relatedNd.cloneNode(true));

      tmpDom = generateXML4Relationship(tmpNd);
      var tds = tmpDom.selectNodes("/table/tr/td");

      for (var i = 0; i < tds.length; i++)
      {
        var td = tds[i];
        var cell = gridApplet.cells(relId, i);
        system_UpdateGridCell(cell, td);
      }
    }

    function addRow(relNd, relatedNd, markDirty)
    {
      if (!relNd) return false;

      //r_copy is a temporary copy of a relationship. Is used only to generate grid row xml.
      var r_copy = relNd.cloneNode(true);
      if (relatedNd) top.aras.setItemProperty(r_copy, "related_id", relatedNd.cloneNode(true), false);
      var resDom = createEmptyResultDom();
      var res = resDom.selectSingleNode(top.aras.XPathResult());
      res.appendChild(r_copy);

      top.aras.uiPrepareDOM4XSLT(resDom, RelType_ID, 'RT_');

      var grid_xml = getGenerateRelationshipsGridXML(resDom);

      xml_ready_flag = false;
      addRowInProgress_Number++;

      var tmpDom = createEmptyResultDom();
      tmpDom.loadXML(grid_xml);
      grid_xml = "<table>" + tmpDom.selectSingleNode("/table/tr").xml + "<\/table>";
      tmpDom = null;
      gridApplet.addXMLRows(grid_xml);
    }

    function onEditCell(mode, rowId, col)
    {
      if (mode == 0 || mode == 2)
        saveInputCol(col);

      if (((mode == 2) || (mode == 21)) && bTabEnterPressed)
      {
        bTabEnterPressed = false;
        bCreateNew = false;
        if (gridApplet.getRowsNum() > 0 && gridApplet.getRowsNum() - 1 == gridApplet.getRowIndex(rowId) &&
        gridApplet.getColumnOrder(Number(col)) == gridApplet.getColumnCount() - 1)
        {
          // +++ determine if Shift pressed
          var ev = document.createEventObject("onclick");
          var isShiftPressed = ev.shiftKey;
          ev = null;
          // --- determine if Shift pressed
          if (!isShiftPressed) bCreateNew = true;
        }
      }

      if (mode == 10)
      {
        // For some type of cells action with mode 2 not happened(Date, Color, etc.)
        bTabEnterPressed = false;
        bCreateNew = false;
        return onGridCellEdit_mode10(rowId, col);
      }

      var cell = gridApplet.cells(rowId, parseInt(col));

      function preserverCheckBoxState()
      {
        cell.setValue('<checkbox state=' + (cell.isChecked() ? '0' : '1') + '>');
      }

      if (mode == 1 || mode == 0)
      {
        // +++ determine if Ctrl pressed
        var ev = document.createEventObject("onclick");
        var isCtrlPressed = ev.ctrlKey;
        ev = null;
        // --- determine if Ctrl pressed

        if (isCtrlPressed)
        {
          if (mode == 1 && cell.isCheckbox()) preserverCheckBoxState();
          return false;
        }
      }

      var isChbox = false;
      var saveFlg = false;
      if (mode == 1)
      {
        isChbox = cell.isCheckbox();

        // change checkbox state back if necessary
        if (isChbox && !isEditMode && !(propsArr[col].DRL == 'R' && getLockedStatusStr(rowId) == 'user'))
        {
          preserverCheckBoxState();
          return false;
        }
        if (isChbox && propsArr[col].DRL == 'R' && (getLockedStatusStr(rowId) != 'user') && (getLockedStatusStr(rowId) != 'new'))
        {
          preserverCheckBoxState();
          return false;
        }

        saveFlg = isChbox;
      }
      else if (mode == 21 && gridApplet.getRowsNum() - 1 == gridApplet.getRowIndex(rowId)) saveFlg = true;

      if (!isEditMode && mode != 0 && !(propsArr[col].DRL == 'R' && getLockedStatusStr(rowId) == 'user')) return;
      if (mode == 0)
        return onGridCellEdit_mode0(rowId, col);

      var res = true;

      if ((mode == 2 || saveFlg) && (!bKEYEDNAME_INPUT_IS_IN_PROGRESS))
      {
        if (isChbox)
        {
          onSelectItem(rowId, col, false, true, true); /// !!!! BUG IN APPLET onselectrow event doesn't occur if you click on checkbox
          if (!isEditMode && !(propsArr[col].DRL == 'R' && getLockedStatusStr(rowId) == 'user')) return;
          if (propsArr[col].DRL == 'R' && getLockedStatusStr(rowId) != 'user' && (getLockedStatusStr(rowId) != 'new')) return;
          currSelCell = cell;
          currSelRowId = rowId;
          currSelCol = col;
        }
        res = onGridCellEdit_mode2(rowId, col);
        if (res) currSelCell = null;
        if (res) bML_STRING_INPUT_IS_IN_PROGRESS = false;
        //    return res;
      }

      //was:  if ( ((mode == 21) || (mode == 2)) && bKEYEDNAME_INPUT_IS_IN_PROGRESS)
      if (mode == 2 && bKEYEDNAME_INPUT_IS_IN_PROGRESS)
      {
        var cell = gridApplet.cells(rowId, parseInt(col));
        res = onInputKeyedNameFinished(cell.getValue(), col);
      }

      if (((mode == 21) || (mode == 2)) && res && bCreateNew)
      {
        bCreateNew = false;
        gridApplet.turnEditOff();
        setTimeout("processCommand('new')", 1);
      }

      return res;
    }

    var zeroError = new Object();
    zeroError.number = 0;
    zeroError.description = top.aras.getResource("", "relationshipsgrid.ok");

    function checkThatItemTypePropsLoaded()
    {
      if (!item.getAttribute("propsLoaded"))
      {
        top.aras.getItemRelationships("ItemType", item.getAttribute("id"), "Property");
        item.setAttribute("propsLoaded", "1");
      }
    }

    function onGridCellEdit_mode0(rowId, col)
    {
      if (!propsArr[col]) return false;
      if (propsArr[col].DRL == 'L') return false;

      if (rowId == 'input_row')
      {
        if (propsArr[col].data_type == "filter list")
        {
          var RelTypeIT;

          checkThatItemTypePropsLoaded();

          if (propsArr[col].DRL == 'R') RelTypeIT = top.aras.getItemProperty(RelType_Nd, 'related_id');
          else RelTypeIT = top.aras.getItemProperty(RelType_Nd, 'relationship_id');

          var filterValue = getFilterValue(rowId, col);
          if (!filterValue) filterValue = "";

          var resObj = top.aras.uiGetFilteredObject4Grid(RelTypeIT, propsArr[col].name, filterValue);

          if (resObj.hasError) return false;

          var _listVals = resObj.values.join(gridApplet.Delimeter);
          var _listLabels = resObj.labels.join(gridApplet.Delimeter);

          gridApplet.cells(rowId, parseInt(col)).setCombo(_listLabels, _listVals);
        }
        else if (propsArr[col].data_type == "date")
        {
          lookup();
          return false;
        }

        filterFlg = true;

        if (RelType_Nm == 'Property' && propsArr[col].name == 'pattern')
        {
          checkThatItemTypePropsLoaded();

          gridApplet.setComboList('', 1);
          gridApplet.setColumnProperties('type=COMBO,list=1', parseInt(col));
          var props = item.selectNodes('Relationships/Item[@type="Property" and (not(@action) or (@action!="delete" and @action!="purge"))]');
          var _listVals = new Array();
          _listVals[0] = ' ';
          for (var i = 0; i < props.length; i++)
          {
            var propNm = top.aras.getItemProperty(props[i], 'name');
            if (propNm == '') propNm = ' ';
            _listVals[i + 1] = propNm;
          }
          _listVals.sort();
          _listVals = _listVals.join(gridApplet.Delimeter);
          gridApplet.cells(rowId, parseInt(col)).setCombo(_listVals, _listVals);
        }

        return true;
      } //if (rowId=='input_row')

      var result = false;
      try
      {
        var isDescBy = (propsArr[col].DRL == 'D');

        // for the foreign properties we should show the cells in read only mode.
        if (propsArr[col].data_type == "foreign")
        {
          checkThatItemTypePropsLoaded();
          return false; //throw zeroError;
        }

        var itm = null;
        var stepNum = 1;
        while (!itm && stepNum < 3)
        {
          if (propsArr[col].DRL == 'D') itm = item.selectSingleNode('Relationships/Item[@id="' + rowId + '"]');
          else if (propsArr[col].DRL == 'R') itm = item.selectSingleNode('Relationships/Item[@id="' + rowId + '"]/related_id/Item');
          // This means that no related item found.
          if (propsArr[col].DRL == 'R' && !itm && item.selectSingleNode('Relationships/Item[@id="' + rowId + '"]/related_id'))
            throw zeroError;
          else if (!itm || itm.getAttribute("loadedPartialy") != "0")
            onSelectItem(rowId, col, true, true, true);
          stepNum++;
        }

        if (!itm) throw zeroError;

        if ((itm.getAttribute("action") == "delete") || (itm.getAttribute("action") == "purge")) return false;

        var RelTypeIT = null;
        if (propsArr[col].DRL == 'R') RelTypeIT = RelatedItemType_Nd;
        else RelTypeIT = DescByItemType_Nd;

        if (!RelTypeIT) throw zeroError;

        var propNm = propsArr[col].name;
        var propNd = RelTypeIT.selectSingleNode('Relationships/Item[@type="Property" and name="' + propNm + '"]');
        if (!propNd) throw zeroError;

        var readonly = (top.aras.getItemProperty(propNd, 'readonly') == '1');
        var canEditCell = !readonly && (isEditMode && isDescBy || (propsArr[col].DRL == 'R' && (getLockedStatusStr(rowId) == 'user' ||
      (hasRelatedItem(rowId) && top.aras.isTempEx(system_getRelatedItem(rowId))))));

        var tryEditCell = false;
        tryEditCell = (!readonly && !canEditCell && isEditMode && propsArr[col].DRL == 'R'
      && (RELATED_IS_DEPENDENT == true));

        var propDT = propsArr[col].data_type;
        var cell = gridApplet.cells(rowId, parseInt(col));
        var prevVal = cell.getValue();

        currSelCell = cell;
        currSelRowId = rowId;
        currSelCol = col;

        var prevVal = systemGetValueForCurrentCell();

        if (canEditCell)
        {
          if (!handleCellEvent('oneditstart', rowId, col))
          {
            currSelCell = null;
            throw zeroError;
          }
        }
        else if (tryEditCell)
        {
          if (!handleCellEvent('oneditstart', rowId, col))
          {
            currSelCell = null;
            throw zeroError;
          }

          var tmpRes = (top.aras.isTempEx(itm) || lockRelatedItem(true));
          if (!tmpRes)
          {
            currSelCell = null;
            if (propDT == 'text') setTimeout('showTextarea(false)', 50);
            if (propDT == 'formatted text') setTimeout("showHTMLEditorDialog('false')", 10);
            throw zeroError;
          }
        }
        else
        {
          currSelCell = null;
          if (propDT == 'text') setTimeout('showTextarea(false)', 50);
          if (propDT == 'formatted text') setTimeout("showHTMLEditorDialog('false')", 10);
          throw zeroError;
        }
        canEditCell = true;

        if (propsArr[col].data_type == "filter list")
        {
          if (rowId != 'input_row')
          {
            var RelTypeIT;
            if (propsArr[col].DRL == 'R') RelTypeIT = top.aras.getItemProperty(RelType_Nd, 'related_id');
            else RelTypeIT = top.aras.getItemProperty(RelType_Nd, 'relationship_id');

            var filterValue = getFilterValue(rowId, col);
            if (!filterValue) filterValue = "";

            var resObj = top.aras.uiGetFilteredObject4Grid(RelTypeIT, propsArr[col].name, filterValue);

            if (resObj.hasError) return false;

            var _listVals = resObj.values.join(gridApplet.Delimeter);
            var _listLabels = resObj.labels.join(gridApplet.Delimeter);

            var cell = gridApplet.cells(rowId, parseInt(col));
            cell.setEditType(2);
            cell.setCombo(_listLabels, _listVals);
          }
        }

        var propSource_ITName = '';

        if (RelType_Nm == 'Property' && isDescBy)
        {
          if (propNm == 'data_source')
          {
            propSource_ITName = top.aras.getItemProperty(itm, 'data_type');
            if (propSource_ITName == 'foreign')
            {
              setTimeout('showForeignPropDialog()', 1);
              throw zeroError;
            }
            else if (propSource_ITName != 'item')
            {
              if (propSource_ITName.search(/^list$|^color list$|^filter list$|^mv_list$/) == 0) propSource_ITName = 'List';
              //          else if (propSource_ITName=='item') propSource_ITName = 'ItemType';
              else if (propSource_ITName == 'sequence') propSource_ITName = 'Sequence';
              else throw zeroError;

              setTimeout('showDialog("' + propSource_ITName + '")', 1);
              throw zeroError;
            }
          }
          else if (propNm == 'pattern')
          {
            if (top.aras.getItemProperty(itm, 'data_type') == 'filter list')
            {
              gridApplet.setComboList('', 1);
              gridApplet.setColumnProperties('type=COMBO,list=1', col);
              var props = item.selectNodes('Relationships/Item[@type="Property" and (not(@action) or (@action!="delete" and @action!="purge"))]');
              var _listVals = new Array();
              _listVals[0] = ' ';
              for (var i = 0; i < props.length; i++)
              {
                var propNm = top.aras.getItemProperty(props[i], 'name');
                if (propNm == '') propNm = ' ';
                _listVals[i + 1] = propNm;
              }

              _listVals.sort();
              _listVals = _listVals.join(gridApplet.Delimeter);
              cell.setCombo(_listVals, _listVals);
            }
            else
              gridApplet.setColumnProperties('type=FIELD', col);
          }

          else if (propNm == 'class_path')
          {
            setTimeout("showClassPathDialog()");
            throw zeroError;
          }
        }
        else if (propNm == "classification" || (propNm == "form_classification" && RelType_Nm == 'View') || (propNm == "class_path" && (RelType_Nm == 'ItemType Life Cycle' || RelType_Nm == 'Can Add')))
        {
          setTimeout("showClassificationDialog('" + propNm + "')");
          throw zeroError;
        }

        if (propDT == 'item')
        {
          if (propNm == 'source_id' && RelType_Nm == 'RelationshipType')
          {
            currSelCell = null;
            throw zeroError;
          }

          if (propNm == 'related_id' && (RELATED_IS_DEPENDENT == true))
          {
            currSelCell = null;
            throw zeroError;
          }

          propSource_ITName = top.aras.getItemTypeName(propsArr[col].data_source);

          if (propSource_ITName == 'File')
          {
            var fileId = top.aras.getItemProperty(itm, propNm);
            setTimeout("showFileDialog('" + fileId + "')", 1);
            throw zeroError;
          }

          bKEYEDNAME_INPUT_IS_IN_PROGRESS = true;
        }
        else if (propDT == 'date')
        {
          var format = top.aras.getItemProperty(propNd, 'pattern');
          format = top.aras.getDotNetDatePattern(format);
          format = format.replace(/\\/g, "\\\\").replace(/'/g, "\\'");

          setTimeout("showDateDialog('" + prevVal + "', '" + format + "')", 10);
          throw zeroError;
        }
        else if (propDT == 'color')
        {
          setTimeout("showColorDialog('" + prevVal + "')", 200);
          throw zeroError;
        }
        else if (propDT == 'text')
        {
          setTimeout('showTextarea(' + canEditCell + ')', 10);
          throw zeroError;
        }
        else if (propDT == 'image')
        {
          var re = /^<img src=["']([^'"]*)['"]/;
          if (re.test(prevVal)) prevVal = RegExp.$1;

          setTimeout('showImageDialog("' + prevVal + '")', 10);
          throw zeroError;
        }
        else if (propDT == 'formatted text')
        {
          setTimeout("showHTMLEditorDialog('" + canEditCell + "')", 10);
          throw zeroError;
        }
        else if (propDT == 'sequence')
          throw zeroError;
        else if (propDT == 'ml_string' && languagesCount > 1)
          bML_STRING_INPUT_IS_IN_PROGRESS = true;

        result = true;
        throw zeroError;
      }
      catch (excep)
      {
        if (excep != zeroError) throw excep;
      }

      return result;
    }

    function onGridCellEdit_mode2(rowId, col)
    {
      var cell = gridApplet.cells(rowId, parseInt(col));

      if (!cell.wasChanged() && rowId != 'input_row')
      {
        handleCellEvent('oneditfinish', currSelRowId, currSelCol);
        return true;
      }

      var RelTypeIT = null;
      if (propsArr[col].DRL == 'R') RelTypeIT = RelatedItemType_Nd;
      else RelTypeIT = DescByItemType_Nd;

      if (!RelTypeIT) return false;

      var prevCurrSelCell = currSelCell;
      var prevCurrSelRowId = currSelRowId;
      var prevCurrSelCol = currSelCol;

      for (var i = 0; i < propsArr.length; i++)
      {
        if (propsArr[i].data_type == "filter list")
        {
          var propNm = propsArr[i].name;
          var propNd = RelTypeIT.selectSingleNode('Relationships/Item[@type="Property" and name="' + propNm + '"]');
          if (!propNd) continue;

          var pattern = top.aras.getItemProperty(propNd, 'pattern');
          if (pattern == propsArr[parseInt(col)].name)
          {
            var tmp1 = propsArr[col].DRL;
            var tmp2 = propsArr[col].name;
            if (tmp1 == "D") tmp1 = getRelationshipProperty(rowId, tmp2);
            else tmp1 = getRelatedItemProperty(rowId, tmp2);

            currSelCell = gridApplet.cells(rowId, i);
            if (gridApplet.cells(rowId, col).getValue() != tmp1)
            {
              currSelRowId = rowId;
              currSelCol = i;
              if (rowId == 'input_row')
              {
                try { gridApplet.cells(rowId, i).setValue("") } catch (e) { }
              }
              else
                setupProperty('');
            }
          }
        }
      }
      if (rowId == 'input_row')
      {
        currSelCell = null;
        currSelRowId = '';
        currSelCol = '';
        return true;
      }

      currSelCell = prevCurrSelCell;
      currSelRowId = prevCurrSelRowId;
      currSelCol = prevCurrSelCol;

      var itm = null;
      if (propsArr[col].DRL == 'D') itm = item.selectSingleNode('Relationships/Item[@id="' + rowId + '"]');
      else if (propsArr[col].DRL == 'R') itm = item.selectSingleNode('Relationships/Item[@id="' + rowId + '"]/related_id/Item');
      if (!itm) return false;

      isDescBy = (propsArr[col].DRL == 'D');

      var val = '';
      var visibleVal = '';

      var propNm = propsArr[col].name;
      var propNd = RelTypeIT.selectSingleNode('Relationships/Item[@type="Property" and name="' + propNm + '"]');
      if (!propNd) throw zeroError;

      var readonly = (top.aras.getItemProperty(propNd, 'readonly') == '1');

      if (cell.isCheckbox())
      {
        if (readonly)
        {
          cell.setChecked(cell.isChecked() ? 0 : 1);
          return true;
        }
        else
          val = cell.isChecked() ? 1 : 0;
      }
      else
        val = cell.getValue();

      var propDT = propsArr[col].data_type;
      if (propDT == 'md5') val = top.aras.calcMD5(val);

      if (propDT != 'item')
      {
        //+++ property validation  
        var propNd = RelTypeIT.selectSingleNode('Relationships/Item[@type="Property" and name="' + propsArr[col].name + '"]');
        var propertyDef =
      {
        data_type: propsArr[col].data_type,
        pattern: top.aras.getItemProperty(propNd, "pattern"),
        is_required: (top.aras.getItemProperty(propNd, "is_required") == "1"),
        stored_length: parseInt(top.aras.getItemProperty(propNd, "stored_length"))
      };

        if (!top.aras.isPropertyValueValid(propertyDef, val, "invariantLocale"))
        {
          var continueEdit = top.aras.showValidationMsg();
          if (continueEdit)
          {
            gridApplet.RequestFocus();
            return false;
          }
          else
            val = top.aras.getItemProperty(itm, propsArr[col].name);
        }
        //--- property validation  
      }
      if (RelType_Nm == 'RelationshipType')
      {
        if (propNm == 'name')
        {
          var relationship_id_Nd = itm.selectSingleNode('relationship_id/Item');
          if (relationship_id_Nd) top.aras.setItemProperty(relationship_id_Nd, 'name', val);
        }
      }

      setupProperty(val, true);
      handleCellEvent('onchangecell', currSelRowId, currSelCol);
      handleCellEvent('oneditfinish', currSelRowId, currSelCol);

      return true;
    }

    function onGridCellEdit_mode10(rowId, col)
    {
      if (rowId == 'input_row') return true;
      if (propsArr[col].DRL == 'L') return false;
      else
      {
        var isDescBy = (propsArr[col].DRL == 'D');

        var itm = null;
        if (propsArr[col].DRL == 'D') itm = item.selectSingleNode('Relationships/Item[@id="' + rowId + '"]');
        else if (propsArr[col].DRL == 'R') itm = item.selectSingleNode('Relationships/Item[@id="' + rowId + '"]/related_id/Item');
        if (!itm) return false;

        var canEditCell = isEditMode && isDescBy || (propsArr[col].DRL == "R" && getLockedStatusStr(rowId).search(/^user$|^new$/) == 0);

        var tryEditCell = false;
        tryEditCell = (!canEditCell && isEditMode && propsArr[col].DRL == 'R' && (RELATED_IS_DEPENDENT == true));

        return true;
      }
    }

    function onInputKeyedNameFinished(val, col)
    {
      var propSource_ITName = top.aras.getItemTypeName(propsArr[col].data_source);

      var tmpItem = top.aras.uiGetItemByKeyedName(propSource_ITName, val);

      bKEYEDNAME_INPUT_IS_IN_PROGRESS = false;

      if (tmpItem)
      {
        var keyedName = tmpItem.selectSingleNode('keyed_name').text;
        var res = tmpItem.getAttribute('id');
        if (propsArr[currSelCol].name == 'related_id' && res != itemID)
        {
          var relatedItm = top.aras.getItemById(RELATED_IT_NAME, res, 0);
          if (!relatedItm)
          {
            top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.failed_get_related_item_id", RELATED_IT_NAME, res));
            setupProperty('', true);
          }
          else
            setupProperty(relatedItm, true);

          var itm = item.selectSingleNode('Relationships/Item[@id="' + currSelRowId + '"]');
          relatedItm = null;
          if (itm) relatedItm = itm.selectSingleNode('related_id/Item');
          updateRow(itm, relatedItm);
          if (itm) updateControls(itm.getAttribute('id'));
        }
        else
        {
          res = tmpItem.cloneNode(false);
          res.setAttribute("action", "skip");
          res.setAttribute("keyed_name", keyedName);
          setupProperty(res, true);
        }
      }
      else
      {
        if (val != "")
        {
          var continueEdit = confirm(top.aras.getResource("", "relationshipsgrid.value_not_exist_for_it", propSource_ITName));
          if (continueEdit)
          {
            bKEYEDNAME_INPUT_IS_IN_PROGRESS = true;
            return false;
          }
          else
          {
            if (currSelRowId)
            {
              var propDRL = propsArr[currSelCol].DRL;
              var propDT = propsArr[currSelCol].data_type;
              var propNm = propsArr[currSelCol].name;

              rel = item.selectSingleNode('Relationships/Item[@type="' + RelType_Nm + '" and @id="' + currSelRowId + '"]');
              if (!rel && propDRL == 'D') return false;
              relId = currSelRowId;

              if (propDRL == 'D') itm = rel;
              else itm = rel.selectSingleNode('related_id/Item');

              var propVal = itm.selectSingleNode(propNm);
              if (propVal)
                propVal = propVal.getAttribute('keyed_name');
              else
                propVal = "";

              currSelCell.setValue(propVal);
            }
          }
        }
        else
        {
          setupProperty('', true);
        }
      }


      handleCellEvent('onchangecell', currSelRowId, currSelCol);
      handleCellEvent('oneditfinish', currSelRowId, currSelCol);
      return true;
    }

    function setupProperty(propVal, markDirty, onlyUI)
    {
      if (!currSelCell) return false;
      var propDRL = propsArr[currSelCol].DRL;
      var propDT = propsArr[currSelCol].data_type;
      var propNm = propsArr[currSelCol].name;
      var itm = null;
      rel = item.selectSingleNode('Relationships/Item[@type="' + RelType_Nm + '" and @id="' + currSelRowId + '"]');
      if (!rel && propDRL == 'D') return false;
      relId = currSelRowId;

      if (propDRL == 'D') itm = rel;
      else itm = rel.selectSingleNode('related_id/Item');

      if (!onlyUI && itm) //because "related item" now not always in opened "item"
      {
        if (propVal.xml != undefined)
        {
          top.aras.setItemProperty(itm, propNm, propVal);

          var propValID = propVal.getAttribute('id');
          // +++ nothing appears in data source cell for the foreign property if source item is a new 
          if (top.aras.isTempEx(propVal) && top.aras.getItemProperty(rel, 'data_type') == 'foreign' && propNm == 'data_source')
          {
            var propKeyedName = propVal.getAttribute('keyed_name');
            if (propKeyedName == '') propKeyedName = propValID;
            var dsNd = rel.selectSingleNode(propNm);
            dsNd.setAttribute('keyed_name', propKeyedName);
          }
          else if (propNm == 'data_source')
          {
            var propKeyedName = propVal.getAttribute('keyed_name');
            if (propKeyedName == '') propKeyedName = propValID;
            var dsNd = rel.selectSingleNode(propNm);
            dsNd.setAttribute('keyed_name', propKeyedName);
          }
          // --- nothing appears in data source cell for the foreign property if source item is a new 
          propVal = propValID;
        }
        else
          top.aras.setItemProperty(itm, propNm, propVal);

        if (propDT == 'ml_string')
          top.aras.setItemPropertyAttribute(itm, propNm, 'xml:lang', top.aras.getSessionContextLanguageCode());
      }

      if (markDirty)
      {
        setDirtyAttribute(item);
        setDirtyAttribute(rel);

        if (propDRL == 'R')
        {
          var relatedId = itm.getAttribute("id");
          var relatedItems = item.selectNodes('Relationships/Item[@type="' + RelType_Nm + '"]/related_id/Item[@id="' + relatedId + '"]');
          for (var i = 0; i < relatedItems.length; i++)
            setDirtyAttribute(relatedItems[i]);
        }

        if (top.updateItemsGrid)
        {
          top.updateItemsGrid(item);
          top.updateItemsGrid(itm, false);
        }
      }

      if (currSelCell)
      {
        var tmpDom = generateXML4Relationship(rel);
        var td = tmpDom.selectSingleNode("/table/tr/td[position()=" + (parseInt(currSelCol) + 1) + "]");
        system_UpdateGridCell(currSelCell, td);
      }
    }

    ////////////////////////////  +++ Dialogs +++  ////////////////////////////
    function onAfterSpecialDialog(dialogRes, acceptEmptyString, specialCase)
    {
      if (acceptEmptyString && (dialogRes == undefined || dialogRes == null)
    || (!acceptEmptyString) && (!dialogRes))
      {
        currSelCell = null;
        grid.requestFocus();
        return;
      }

      if ((specialCase !== undefined) && (dialogRes === specialCase)) dialogRes = "";

      var prevVal = systemGetValueForCurrentCell();

      setupProperty(dialogRes, true);

      // +++ fire onchangecell and oneditfinish events
      if (prevVal !== dialogRes) handleCellEvent("onchangecell", currSelRowId, currSelCol);

      handleCellEvent("oneditfinish", currSelRowId, currSelCol);
      // --- fire onchangecell and oneditfinish events

      currSelCell = null;
      grid.requestFocus();
    }

    function showDialog(IT_Name)
    {
      var itm = item.selectSingleNode("Relationships/Item[@id='" + currSelRowId + "']" + ((propsArr[currSelCol].DRL == 'R') ? "/related_id/Item" : ""));
      var curITName = (itm) ? itm.getAttribute("type") : "";
      var curPropName = propsArr[currSelCol].name;

      var param = { aras: top.aras, itemtypeName: IT_Name, itemContext: item, itemSelectedID: currSelRowId, sourceItemTypeName: curITName, sourcePropertyName: curPropName, multiselect: false };
      var dlgRes = showModalDialog('searchDialog.html', param, 'dialogHeight:450px; dialogWidth:700px; status:0; help:0; resizable:1');
      if (dlgRes == undefined) return false;

      gridApplet.setPaintEnabled(false);
      try
      {

        if (dlgRes.itemID)
        {
          bKEYEDNAME_INPUT_IS_IN_PROGRESS = false;

          var keyedName = dlgRes.keyed_name;
          var res = dlgRes.itemID;

          if (propsArr[currSelCol].name == 'related_id' && res != itemID)
          {
            var relatedItm = top.aras.getItemById(RELATED_IT_NAME, res, 0);
            if (!relatedItm)
            {
              top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.failed_get_related_item_id", RELATED_IT_NAME, res));
              setupProperty('', true);
            }
            else setupProperty(relatedItm, true);

            var itm = item.selectSingleNode('Relationships/Item[@id="' + currSelRowId + '"]');
            relatedItm = null;
            if (itm) relatedItm = itm.selectSingleNode('related_id/Item');
            updateRow(itm, relatedItm);
            if (itm) updateControls(itm.getAttribute('id'));
          }
          else
          {
            res = dlgRes.item.cloneNode(false);
            res.setAttribute("action", "skip");
            res.setAttribute("keyed_name", keyedName);

            setupProperty(res, true);
          }
        }
        else setupProperty('', true);

        handleCellEvent('oneditfinish', currSelRowId, currSelCol);
        currSelCell = null;
        gridApplet.turnEditOff();
      } catch (ex) { }
      gridApplet.setPaintEnabled(true);
    }

    function showMLDialog()
    {
      var itm = item.selectSingleNode("Relationships/Item[@id='" + currSelRowId + "']" + ((propsArr[currSelCol].DRL == 'R') ? "/related_id/Item" : ""));
      var curITName = (itm) ? itm.getAttribute("type") : "";
      var curPropName = propsArr[currSelCol].name;

      var oldVal = top.aras.getItemProperty(itm, curPropName);

      var param = { aras: top.aras, itemContext: itm, sourceItemTypeName: itm.getAttribute('type'), sourcePropertyName: curPropName, isEditMode: isEditMode };
      var dlgRes = top.showModalDialog('MLDialog.html', param, 'dialogHeight: 250px; dialogWidth: 500px; status:0; help:0; resizable:1');
      if (!dlgRes) return false;

      var newVal = top.aras.getItemProperty(itm, curPropName);
      setupProperty(oldVal, true);
      setupProperty(newVal, true);
      bML_STRING_INPUT_IS_IN_PROGRESS = false;

      gridApplet.setPaintEnabled(false);
      handleCellEvent('oneditfinish', currSelRowId, currSelCol);
      currSelCell = null;
      gridApplet.turnEditOff();
      gridApplet.setPaintEnabled(true);
      return true;
    }

    function showClassStructureDialog(it, dialogType, title)
    {
      var class_structure = top.aras.getItemProperty(it, "class_structure");
      if (!class_structure) class_structure = "<class name=\"" + top.aras.getItemProperty(it, "name") + "\" />";

      if (item.getAttribute("type") == "ItemType")
      {
        var PropNds = top.aras.getItemRelationshipsEx(item, "Property");
        var relshipsXml = top.aras.createXMLDocument();
        relshipsXml.loadXML("<Relationships />");
        if (PropNds != null)
        {
          for (var i = 0; i < PropNds.length; i++)
          {
            if (!item.selectSingleNode('Relationships/Item[@id="' + PropNds(i).getAttribute("id") + '"]'))
              relshipsXml.documentElement.appendChild(PropNds(i).cloneNode(true));
          }
        }

        top.aras.mergeItemRelationships(item, relshipsXml);
      }

      function showClassStructureDialog()
      {
        var param = new Object();
        param.aras = top.aras;
        param.isEditMode = isEditMode;
        param.class_structure = class_structure;
        param.dialogType = dialogType;
        param.title = title;
        param.selectLeafOnly = !(itemTypeName == "ItemType" && (RelType_Nm == "Property" || RelType_Nm == "ItemType Life Cycle" || RelType_Nm == "Can Add"));
        return showModalDialog("ClassStructureDialog.html", param, "help:0;resizable:1;status:0;");
      }

      var res;

      if (RelType_Nm == "View")
      {
        // return (bool): True if continue needed.     
        function showContinueDialog(message)
        {
          var param = new Object();
          param.buttons = new Object();
          param.buttons.btnYes = top.aras.getResource("", "common.yes");
          param.buttons.btnCancel = top.aras.getResource("", "common.cancel");
          param.defaultButton = 'btnCancel';
          param.message = message;
          var resButton = showModalDialog('groupChgsDialog.html', param, 'dialogHeight:300px;dialogWidth:400px;center:yes;resizable:yes;status:no;help:no;');
          if (resButton == 'btnCancel')
          {
            return false;
          }
          return true;
        }

        //if form_classification property is changed we should ask user for fields that would be deleted from form
        var viewItem = item.selectSingleNode("Relationships/Item[@type='View' and @id='" + currSelRowId + "']");

        var formNd = viewItem.selectSingleNode("related_id/Item[@type='Form']");
        if (!formNd)
        {
          top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.no_form_view"));
          return false;
        }

        var isTempForm = top.aras.isTempEx(formNd);
        var formIsComplete = isTempForm;
        var changeTheForm = true;

        if (!isTempForm)
        {
          // check if View relationship contains complete Form definition. The criteria is Body existence.
          var bodyNd = formNd.selectSingleNode("Relationships/Item[@type='Body']");
          formIsComplete = (bodyNd != null);

          if (!top.aras.isLockedByUser(formNd))
          {
            if (top.aras.isLocked(formNd))
            {
              if (!showContinueDialog(top.aras.getResource("", "relationshipsgrid.locked_another_user_change_view_classification")))
              {
                return false;
              }
              changeTheForm = false;
            }
          }
        }

        res = showClassStructureDialog();

        if (changeTheForm && res !== undefined && systemGetValueForCurrentCell() !== res)
        {
          //++++ remove fields out of the classification of the form (formItemNd)
          var propsMayDel = top.aras.selectPropNdsByClassPath(res, item, true);
          if (propsMayDel.length != 0)
          {
            var whereClause = "";
            for (var i = 0; i < propsMayDel.length; i++)
            {
              whereClause += "propertytype_id='" + propsMayDel[i].getAttribute("id") + "'";
              if (i != propsMayDel.length - 1) whereClause += " or ";
            }

            function getCompleteForm()
            {
              if (!formIsComplete)
              {
                var formId = formNd.getAttribute("id");

                var requestedFormNd = top.aras.getItemById("Form", formId, 3);
                if (!requestedFormNd)
                {
                  top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.form_defined_view_not_found"));
                  return false;
                }

                top.aras.mergeItem(formNd, requestedFormNd);
                formIsComplete = true;
              }

              return true;
            }

            if (!getCompleteForm())
            {
              onAfterSpecialDialog(undefined, true);
              return false;
            }

            var fieldsToDel = formNd.selectNodes("Relationships/Item/Relationships/Item[" + whereClause + "]");
            if (fieldsToDel.length != 0)
            {
              var message = top.aras.getResource("", "relationshipsgrid.modifying_class_value_remove_fields");
              for (var i = 0; i < fieldsToDel.length; i++)
                message += "<b>" + top.aras.getItemProperty(fieldsToDel[i], "label") + "<\/b><br>";

              message += top.aras.getResource("", "relationshipsgrid.continue_remove");

              if (!showContinueDialog(message))
              {
                onAfterSpecialDialog(undefined, true);
                return true;
              }

              if (!isTempForm && !top.aras.isLockedByUser(formNd))
              {
                formNd = top.aras.lockItemEx(formNd);
                if (!formNd)
                {
                  top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.form_cannot_be_locked"));
                  onAfterSpecialDialog(undefined, true);
                  return false;
                }

                formIsComplete = false;
                if (!getCompleteForm())
                {
                  onAfterSpecialDialog(undefined, true);
                  return false;
                }
              }

              fieldsToDel = formNd.selectNodes("Relationships/Item/Relationships/Item[" + whereClause + "]");

              if (fieldsToDel.length > 0)
              {
                //delete fields
                for (var i = 0; i < fieldsToDel.length; i++)
                {
                  var fieldToDel = fieldsToDel[i];
                  if (fieldToDel.getAttribute("action") == "add") fieldToDel.parentNode.removeChild(fieldsToDel[i]);
                  else fieldToDel.setAttribute("action", "delete");
                }

                setDirtyAttribute(formNd);
              }
            }
          }
        }
        //---- remove fields out of the classification of the form (formItemNd)
      }
      else
      {
        res = showClassStructureDialog()
      }

      onAfterSpecialDialog(res, true);
    }

    function showClassificationDialog(type)
    {
      var propDRL = propsArr[currSelCol].DRL;

      var it = ((propDRL == "D") ? DescByItemType_Nd : RelatedItemType_Nd);
      if (type == "form_classification" || type == "class_path")
        it = item;
      var dialogType = "classification";
      var title = "classification";

      showClassStructureDialog(it, dialogType, title);
    }

    function showClassPathDialog()
    {
      //item is an ItemType instance in this case
      var itemLbl = top.aras.getItemProperty(item, "label");
      if (!itemLbl) itemLbl = top.aras.getItemProperty(item, "name");
      var rel = item.selectSingleNode("Relationships/Item[@type=\"Property\" and @id=\"" + currSelRowId + "\"]");

      var it = item;
      var dialogType = "class_path";
      var title = top.aras.getResource("", "relationshipsgrid.class_path_prop", top.aras.getItemProperty(rel, "name"), itemLbl);

      showClassStructureDialog(it, dialogType, title);
    }

    function showFileDialog(fileId)
    {
      var fileNd = top.aras.newItem('File');
      gridApplet.requestFocus();
      if (!fileNd) return true;

      onAfterSpecialDialog(fileNd, false);
    }

    function showDateDialog(oldDate, format)
    {
      if (!currSelCell) return;
      var param = new Object();
      param.date = top.aras.convertFromNeutral(oldDate, 'date', format);
      param.format = format;
      param.aras = top.aras;

      var newDate = top.aras.uiShowDialogNearElement(grid, top.aras.getScriptsURL() + 'dateDialog.html', param, undefined, undefined, currSelCell.getBounds());
      if (newDate !== undefined) newDate = top.aras.convertToNeutral(newDate, 'date', format);

      onAfterSpecialDialog(newDate, true);
    }

    function showColorDialog(oldColor)
    {
      if (oldColor == '') oldColor = '#FFFFFF';
      var newColor = '';
      if (top.tearoff_menu) newColor = top.tearoff_menu.document.colorApplet.getColor(oldColor);
      else newColor = top.menu.document.colorApplet.getColor(oldColor);

      onAfterSpecialDialog(newColor, false);
    }

    function systemGetValueForCurrentCell()
    {
      var propNm = propsArr[currSelCol].name;
      var propDRL = propsArr[currSelCol].DRL;

      var res = ((propDRL == "D") ? getRelationshipProperty(currSelRowId, propNm) : getRelatedItemProperty(currSelRowId, propNm));

      return res;
    }

    function showTextarea(openToEdit)
    {
      if (openToEdit == undefined) openToEdit = false;

      var param = new Object();
      param.isEditMode = openToEdit;
      param.content = systemGetValueForCurrentCell();
      param.aras = top.aras;

      var res = showModalDialog("textDialog.html", param, "resizable:yes;status:no;help:no;dialogWidth:600px;dialogHeight:450px;");

      onAfterSpecialDialog(res, true);
    }

    function showImageDialog(img)
    {
      if (!img) img = '';
      var params = new Object();
      params.aras = top.aras;
      params.image = img;
      var res = showModalDialog('ImageBrowser/imageBrowser.html', params, 'dialogHeight:400px; dialogWidth:600px; status:0; help:0');

      onAfterSpecialDialog(res, false, "set_nothing");
    }

    function showHTMLEditorDialog(openToEdit)
    {
      if (openToEdit == 'false')
      {
        var content = systemGetValueForCurrentCell();
        content = content.replace(/\\/g, "\\\\");
        content = content.replace(/\\n/g, '\n');
        content = content.replace(/'/g, '\\\'');
        showModalDialog("javascript: '" + content + "'", '', 'status:0; help:0; resizable:1;');
      }
      else
      {
        var param = new Object();
        param.sHTML = systemGetValueForCurrentCell();
        param.aras = top.aras;
        var res = top.showModalDialog('HTMLEditorDialog.html', param, 'status:0; help:0; resizable:1;');

        onAfterSpecialDialog(res, true);
      }
    }

    function showForeignPropDialog()
    {
      var param = new Object();
      param.aras = top.aras;
      param.item = item;
      checkThatItemTypePropsLoaded();
      var res = showModalDialog('foreignPropSelectTree.html', param, 'dialogHeight:600px;dialogWidth:250px;scroll:no;status:no;');
      if (res)
      {
        setRelationshipProperty(currSelRowId, 'data_source', res.data_source);

        var relNd = item.selectSingleNode('Relationships/Item[@type="' + relationshipTypeName + '" and @id="' + currSelRowId + '"]');
        top.aras.setItemProperty(relNd, 'foreign_property', res.foreign_property);
      }
    }
    ////////////////////////////  --- Dialogs ---  ////////////////////////////

    function handleRowEvent(eventName, rowId)
    {
      var EventName = 'row_' + eventName;
      var funcName = 'row_' + eventName + '_func';
      var retValue = handleEvent(rowEventsNames, rowEventsMethods_code, EventName, funcName, rowId);
      return retValue;
    }

    function handleCellEvent(eventName, rowId, col)
    {
      var prop = propsArr[col];
      var EventName = prop.name + '_' + prop.DRL + '_' + eventName;
      var funcName = prop.name + '_' + prop.DRL + '_' + eventName + '_func';
      var retValue = handleEvent(cellEventsNames, cellEventsMethods_code, EventName, funcName, rowId, col);
      return retValue;
    }

    function handleEvent(eventsNames, eventsMethods_code, EventName, funcName, rowId, col)
    {
      var retValue = true;
      // if col is defined it means cell event occurs. Else it's row event
      if (col != undefined)
        var prop = propsArr[col];

      var HandlersQueue = window[funcName];

      if (HandlersQueue == undefined)
      {
        var HasEvents = false;
        for (var i = 0; i < eventsNames.length; i++)
        {
          if (eventsNames[i] == EventName)
          {
            HasEvents = true;
            var method_code = eventsMethods_code[i];
            try
            {
              if (col != undefined)
                handler = new Function('relationshipID', 'relatedID', 'propertyName', 'colNumber', 'gridApplet', method_code);
              else
                handler = new Function('relationshipID', 'relatedID', 'gridApplet', method_code);

              if (!window[funcName]) window[funcName] = new Array();
              window[funcName].push(handler);
            }
            catch (excep)
            {
              top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.internal_error_event_failed_initialize"), top.aras.getResource("", "relationshipsgrid.custom_event_failed", eventName, excep.description), top.aras.getResource("", "common.client_side_err"));
              return false;
            }
          }
        }
        if (HasEvents)
          HandlersQueue = window[funcName];
        else
          window[funcName] = null;
      }

      if (HandlersQueue)
      {
        for (var i = 0; i < HandlersQueue.length; i++)
        {
          var handler = HandlersQueue[i];
          var relationshipID = rowId;
          var relatedID = undefined;
          if (hasRelatedItem(rowId))
            relatedID = system_getRelatedItem(rowId).getAttribute("id");

          try
          {
            if (col != undefined)
              retValue = handler(relationshipID, relatedID, prop.name, col, gridApplet);
            else
              retValue = handler(relationshipID, relatedID, gridApplet);
          }
          catch (excep)
          {
            top.aras.AlertError(top.aras.getResource("", "relationshipsgrid.internal_err_event_failed"), top.aras.getResource("", "relationshipsgrid.failed_with_msg", EventName, excep.description), top.aras.getResource("", "common.client_side_err"));
            return false;
          }
          if (retValue === false)
            break;
        }
      }
      if (retValue === undefined) retValue = true;
      return retValue;
    }

    //+++ some functions for custom events handlers
    function setRelationshipProperty(relID, propName, propVal)
    {
      for (var col = 0; col < propsArr.length; col++)
        if (propsArr[col].DRL == 'D' && propsArr[col].name == propName) break;
      if (col == propsArr.length) return false;

      var relNd = item.selectSingleNode('Relationships/Item[@type="' + relationshipTypeName + '" and @id="' + relID + '"]');
      if (!relNd) return false;

      var prevCurrSelCell = currSelCell;
      var prevCurrSelRowId = currSelRowId;
      var prevCurrSelCol = currSelCol;

      try
      {
        var prevVal = top.aras.getItemProperty(relNd, propName);

        currSelRowId = relID;
        currSelCol = col;
        currSelCell = gridApplet.cells(relID, parseInt(col));

        setupProperty(propVal, true, false);

        if (currSelCell && propVal != prevVal)
          handleCellEvent('onchangecell', currSelRowId, currSelCol);
      }
      catch (excep) { }
      finally
      {
        currSelCell = prevCurrSelCell;
        currSelRowId = prevCurrSelRowId;
        currSelCol = prevCurrSelCol;
      }

      return true;
    }

    function setRelatedItemProperty(relID, propName, propVal)
    {
      for (var col = 0; col < propsArr.length; col++)
        if (propsArr[col].DRL == 'R' && propsArr[col].name == propName) break;
      if (col == propsArr.length) return false;

      var relatedNd = item.selectSingleNode('Relationships/Item[@type="' + relationshipTypeName + '" and @id="' + relID + '"]/related_id/Item');
      if (!relatedNd) return false;

      var prevCurrSelCell = currSelCell;
      var prevCurrSelRowId = currSelRowId;
      var prevCurrSelCol = currSelCol;

      try
      {
        var prevVal = top.aras.getItemProperty(relatedNd, propName);

        currSelRowId = relID;
        currSelCol = col;
        currSelCell = gridApplet.cells(relID, parseInt(col));

        setupProperty(propVal, true, false);

        if (currSelCell && propVal != prevVal)
          handleCellEvent('onchangecell', currSelRowId, currSelCol);
      }
      catch (excep) { }
      finally
      {
        currSelCell = prevCurrSelCell;
        currSelRowId = prevCurrSelRowId;
        currSelCol = prevCurrSelCol;
      }

      return true;
    }

    function getRelationshipProperty(relID, propName)
    {
      var relNd = item.selectSingleNode('Relationships/Item[@type="' + relationshipTypeName + '" and @id="' + relID + '"]');
      if (!relNd) return undefined;

      return top.aras.getItemProperty(relNd, propName);
    }

    function getRelatedItemProperty(relID, propName)
    {
      var relatedNd = item.selectSingleNode('Relationships/Item[@type="' + relationshipTypeName + '" and @id="' + relID + '"]/related_id/Item');
      if (!relatedNd) return undefined;

      return top.aras.getItemProperty(relatedNd, propName);
    }
    //^^^ some functions for custom events handlers


    function setDirtyAttribute(relationships_itemNd)
    {
      var tmpItemTypeName = relationships_itemNd.getAttribute('type');
      var act = relationships_itemNd.getAttribute('action');
      if (!act || (act != 'add' && act != 'create' && act != 'delete' && act != 'purge'))
        relationships_itemNd.setAttribute('action', 'update');

      if (relationships_itemNd.getAttribute('isDirty') != '1')
      {
        relationships_itemNd.setAttribute('isDirty', '1');

        try
        {
          if (parent.opener.top.main.work.itemTypeName == tmpItemTypeName)
            with (parent.opener.top.main.work)
            if (gridApplet.getRowIndex(relationships_itemNd.getAttribute('id')) > -1)
            updateRow(relationships_itemNd);
        }
        catch (excep) { }
      }
    }

    function onTabSelected()
    {
      if (!gridReady || !scriptReady || document.readyState != 'complete') return;
      if (bTOOLBAR_IS_USED) updateToolbar();
    }

    function getPasteFlg()
    {
      return !isWorkflowTool() && !top.aras.clipboard.isEmpty() &&
        top.aras.isLCNCompatibleWithRT(RELATED_IT_NAME) && computeCorrectControlState("new");
    }

    function getPasteSpecialFlg()
    {
      return !isWorkflowTool() && !top.aras.clipboard.isEmpty() && computeCorrectControlState("new");
    }

    function isWorkflowTool()
    {
      return parent.parent.isWorkflowTool;
    }

    var sortPriority = null;
    function calculateSortPriority(grid_view)
    {
      if (propsArr == undefined) return;

      // +++ sort columns
      var Dpriority = 0, Rpriority = 0;
      if (grid_view == "left")
      {
        //related item goes first
        Dpriority = 1;
        Rpriority = 0;
      }
      else if (grid_view == "intermix")
      {
        Dpriority = 0;
        Rpriority = 0;
      }
      else
      {
        Dpriority = 0;
        Rpriority = 1;
      }

      sortPriority = new Array();

      for (var i = 0; i < propsArr.length; i++)
        if (propsArr[i].order_by == "" || propsArr[i].order_by == undefined || propsArr[i].DRL == "L");
      else
      {
        sortPriority.push(
        {
          colNum: i,
          order_by: parseInt(propsArr[i].order_by),
          priority: (propsArr[i].DRL == "D") ? Dpriority : Rpriority
        }
      )
      }

      function sorterF(p1, p2)
      {
        var c1 = p1.priority;
        var c2 = p2.priority;

        if (c1 < c2) return -1;
        else if (c2 < c1) return 1;
        else
        {
          c1 = p1.order_by;
          c2 = p2.order_by;

          if (isNaN(c2)) return -1;
          if (isNaN(c1)) return 1;

          if (c1 < c2) return -1;
          else if (c2 < c1) return 1;
          else return 0;
        }
      }

      sortPriority.sort(sorterF);
    }

    function sortRowByDefault()
    {
      if (sortPriority)
        try
      {
        if (sortPriority.length != 0) gridApplet.sort(sortPriority[0].colNum, true);
        for (var i = 1; i < sortPriority.length; i++)
        {
          var cPriority = sortPriority[i];
          if (cPriority.order_by >= 0) gridApplet.sortEx(cPriority.colNum, true);
        }
      }
      catch (e)
      {
      }
      gridApplet.setPaintEnabled(true);
    }

    function getFilterValue(rowId, col)
    {
      // rowId and col are for cell where filter list is supposed.
      var RelTypeIT = null;
      if (propsArr[col].DRL == 'R') RelTypeIT = RelatedItemType_Nd;
      else RelTypeIT = DescByItemType_Nd;

      if (!RelTypeIT) return false;

      var propNm = propsArr[col].name;
      var propNd = RelTypeIT.selectSingleNode('Relationships/Item[@type="Property" and name="' + propNm + '"]');
      if (!propNd) return false;

      var pattern = top.aras.getItemProperty(propNd, 'pattern');
      for (var i = 0; i < propsArr.length; i++)
      {
        if (propsArr[i].name == pattern) break;
      }
      if (i == propsArr.length) return false;

      var res = "";
      if (rowId == 'input_row')
      {
        try
        {
          res = gridApplet.cells(rowId, i).getValue();
        } catch (ex) { }
      } else
      {
        var tmp1 = propsArr[i].DRL;
        var tmp2 = propsArr[i].name;
        if (tmp1 == "D") tmp1 = getRelationshipProperty(rowId, tmp2);
        else tmp1 = getRelatedItemProperty(rowId, tmp2);
        res = tmp1;
      }
      return res;
    }

    function scriptInit()
    {
      relationshipTypeActions[RelType_ID] = new Object();
      relationshipActions[RelType_ID] = new Object();

      var res = top.aras.getItemTypeDictionary(top.aras.getItemTypeName(DescByItemType_ID)).node;
      var nds = res.selectNodes("Relationships/Item[@type='Item Action']/related_id/Item[type='itemtype' and name]");
      for (var i = 0; i < nds.length; i++)
      {
        var act = nds.item(i);
        if (top.aras.isInCache(act.getAttribute("id")))
          act = top.aras.getFromCache(act.getAttribute("id"));
        var lbl = top.aras.getItemProperty(act, "label");
        if (!lbl) lbl = top.aras.getItemProperty(act, "name");
        relationshipTypeActions[RelType_ID][act.getAttribute("id")] = lbl;
      }

      var nds = res.selectNodes("Relationships/Item[@type='Item Action']/related_id/Item[type='item' and name]");
      for (var i = 0; i < nds.length; i++)
      {
        var act = nds.item(i);
        if (top.aras.isInCache(act.getAttribute("id")))
          act = top.aras.getFromCache(act.getAttribute("id"));
        var lbl = top.aras.getItemProperty(act, "label");
        if (!lbl) lbl = top.aras.getItemProperty(act, "name");
        relationshipActions[RelType_ID][act.getAttribute("id")] = lbl;
      }

      // +++++ setup Relationship Grid Events (row events) ++++++
      var res = top.aras.getRelationshipType(RelType_ID).node;
      nds = res.selectNodes("Relationships/Item[grid_event != '' and related_id/Item/method_code != '']");

      for (var i = 0; i < nds.length; i++)
      {
        rowEventsNames[i] = "row_" + top.aras.getItemProperty(nds[i], "grid_event");
        rowEventsMethods_code[i] = top.aras.getItemProperty(nds[i], "related_id/Item/method_code");
      }
      // ^^^^^^ setup Relationship Grid Events (row events) ^^^^^^

      // ++++++ setup Grid Events (cell events) ++++++
      var critStr = "";
      for (var i = 0; i < propsArr.length; i++)
      {
        if (propsArr[i].propID) critStr += "'" + propsArr[i].propID + "',";
      }

      if (critStr)
      {
        var res = top.aras.getItemTypeDictionary(top.aras.getItemTypeName(DescByItemType_ID)).node;
        nds = res.selectNodes("Relationships/Item[@type='Property']/Relationships/Item[grid_event != '' and related_id/Item/method_code != '']");

        for (var i = 0; i < nds.length; i++)
        {
          var ev = nds[i];
          var EventName = top.aras.getItemProperty(ev, "source_id/Item/name") + "_";
          var parentIT_ID = top.aras.getItemProperty(ev, "source_id/Item/source_id");
          EventName += (parentIT_ID == DescByItemType_ID ? "D" : "R");
          EventName += "_" + top.aras.getItemProperty(ev, "grid_event");
          cellEventsNames[i] = EventName;
          cellEventsMethods_code[i] = top.aras.getItemProperty(ev, "related_id/Item/method_code");
        }

        if (RelatedItemType_Nd)
        {
          nds = RelatedItemType_Nd.selectNodes("Relationships/Item[@type='Property']/Relationships/Item[grid_event != '' and related_id/Item/method_code != '']");
          var curEventsCount = cellEventsNames.length;
          for (var i = 0; i < nds.length; i++)
          {
            var ev = nds[i];
            var EventName = top.aras.getItemProperty(ev, "source_id/Item/name") + "_";
            var parentIT_ID = top.aras.getItemProperty(ev, "source_id/Item/source_id");
            EventName += (parentIT_ID == DescByItemType_ID ? "D" : "R");
            EventName += "_" + top.aras.getItemProperty(ev, "grid_event");
            cellEventsNames[i + curEventsCount] = EventName;
            cellEventsMethods_code[i + curEventsCount] = top.aras.getItemProperty(ev, "related_id/Item/method_code");
          }
        }
      }
      // ^^^^^^ setup Grid Events (cell events) ^^^^^^

      scriptReady = true;
    }
  </script>

  <script type="text/javascript" for="toolbar" event="Onload()">
    toolbarReady = true;
    loadToolbar();
  </script>

  <script type="text/javascript" for="toolbar" event="Onclick(tbItem)">
    // Click on next buttons will be handled by SearchContainer.
    var tbId = tbItem.getId();
    if (tbId != 'search' && tbId != 'newsearch' && tbId != 'stop_search' && tbId != 'select_all' && tbId != 'next_page' && tbId != 'prev_page')
      onToolbarButtonClick(tbItem);
  </script>

  <script type="text/javascript" for="toolbar" event="OnDropDownItemClick(cmdId)">
    onRelationshipsMenuClickItem(cmdId);
  </script>

  <script type="text/javascript" for="grid" event="GridStart(isSuccess)">
    gridReady = true;
  </script>

  <script type="text/javascript" for="grid" event="GridXmlLoaded(isSuccess)">
    onXmlLoaded();
  </script>

  <script type="text/javascript" for="grid" event="GridMenuInit(rowId, col, p)">
    onSelectItem(rowId, col);
    return onMenuCreate(rowId, col, p);
  </script>

  <script type="text/javascript" for="grid" event="GridMenuClick(m, rowId, col)">
    onRelationshipPopupMenuClicked(m, rowId, col);
  </script>

  <script type="text/javascript" for="grid" event="GridEditCell(mode, rowID, col)">
    return onEditCell(mode, rowID, col);
  </script>

  <script type="text/javascript" for="grid" event="GridLinkClick(strLink)">
    eval("onLink("+strLink+")");
  </script>

  <script type="text/javascript" for="grid" event="GridDoubleClick(rowId)">
    onDoubleClick(rowId);
  </script>

  <script type="text/javascript" for="grid" event="GridKeyPress(kEv)">
    return onKeyPressed(kEv);
  </script>

  <script type="text/javascript" for="grid" event="GridClick(rowId,col)">
    onSelectItem(rowId, col);
  </script>

<!----    Drag and Drop Code Start  ----------->
<script language="jscript" for="grid" event="DragEnter(a, b)">
  if(RELATED_IT_NAME=='File' && b.Data.GetDataPresent("FileDrop") && isEditMode)  {b.Effect = -2147483645;return;}

  if(RELATED_IT_NAME=='File' && b.Data.GetDataPresent("FileGroupDescriptor") && isEditMode)  {b.effect = -2147483645;return;}

</script>

<script language="jscript" for="grid" event="DragDrop(a, b)">
   // first test is for Windows Explorer objects
   if (RELATED_IT_NAME=='File' &&  b.Data.GetDataPresent("FileDrop") && isEditMode) {
		var fileNames = b.Data.GetData("FileDrop");
		var arrayListOfFiles = top.aras.utils.GetArrayListForStringArray(fileNames);

		var topItem = top.document.frames[1].document.thisItem;
		var myInnovator = topItem.newInnovator();

		for (var i = 0; i < arrayListOfFiles.count; i++) {
			var file = arrayListOfFiles(i);
			var filename = file.substring(file.lastIndexOf("\\") + 1, file.length);


			var fileNd = top.aras.newFileItem(file);

			if (!fileNd) {
				alert('Error on file handling');
				return;
			}

			var NewRelItem = myInnovator.newItem(RelType_Nm,"add");
			var fileItem = myInnovator.newItem();
			fileItem.loadAML( fileNd.xml );

         fileNd = null;
			topItem.setAttribute("isDirty","1");

			NewRelItem.setPropertyItem("related_id",fileItem);
			topItem.addRelationship(NewRelItem);


  		} // for loop
  		// repaint the grid
  		top.document.frames[2].iframesCollection[top.document.frames[2].currTabID].contentWindow.doSearch(1);
  		return;
    }
    // next code handles Outlook Attachments
    if(RELATED_IT_NAME=='File' && b.Data.GetDataPresent("FileGroupDescriptor") && isEditMode)  {

		var myOutlook = new ActiveXObject("Outlook.Application");
		var topItem = top.document.frames[1].document.thisItem;
		var myInnovator = topItem.newInnovator();

      //  need to ask Outlook which items are selected
		var myExp=myOutlook.ActiveExplorer();
		var msgCount = myExp.selection.count;
		var myResult = top.aras.createXMLDocument();
		for (var c=1; c<=msgCount; c++) {
			var myMailItem=myExp.Selection.Item(c);

			var attachments = myMailItem.Attachments;
			var attachmentCount = attachments.Count;
			for (var attachmentIndex = 1; attachmentIndex<=attachmentCount; attachmentIndex++ ) {

				var attachment = attachments.Item(attachmentIndex);
				var fileName= attachment.FileName;

				var saveResult = attachment.SaveAsFile("c:/" + fileName);

				var fileNd = top.aras.newFileItem("c:\\" + fileName);

				if (!fileNd) {
					alert('Error on Drag-n-Drop file handling');
					return;
				}

				var NewRelItem = myInnovator.newItem(RelType_Nm,"add");
				var fileItem = myInnovator.newItem();
				fileItem.loadAML( fileNd.xml );

				fileNd = null;
				topItem.setAttribute("isDirty","1");

				NewRelItem.setPropertyItem("related_id",fileItem);
				topItem.addRelationship(NewRelItem);

				} // loop on Attachments
		} // for loop on Messages

		myOutlook = null;
  		// repaint the grid
  		top.document.frames[2].iframesCollection[top.document.frames[2].currTabID].contentWindow.doSearch(1);
		return;
    } // test if this was an Outlook drop

</script>
<!---  End of Drag and Drop code  --->
  <table border="0" style="width: 100%; height: 100%; table-layout: fixed;" cellspacing="0"
    cellpadding="0">
    <tr id="toolbar_container" style="display: none; height: 28px;">
      <td>

        <script type="text/javascript">
          var tmpIsToolbarUsed = false;
          if (bTOOLBAR_IS_USED)
          {
            tmpIsToolbarUsed = true;
            document.write(
            '<comment id=\'toolbar_commented\'>' +
            ' <object id=\'toolbar\'' +
            '   style=\'width:100%; height:100%;\'' +
            '   classid=\'..\/cbin\/Toolbar.dll#Aras.Client.Controls.Toolbar\'>' +
            ' <\/object>' +
            '<\/comment>');
            WriteUncommentedObject("toolbar_commented");
          }
          else if (CUSTOM_TOOLBAR_SRC)
          {
            tmpIsToolbarUsed = true;
            document.write('<iframe id=\'toolbar_slot_custom_iframe\' src=\'' + CUSTOM_TOOLBAR_SRC + '\' frameborder=\'0\' style=\'width:100%; height:100%;\'><\/iframe>');
          }

          if (tmpIsToolbarUsed)
            document.getElementById("toolbar_container").style.display = "";
        </script>

      </td>
    </tr>
    <tr id="searchPlaceholder" style="display: none; height: 0px;">
    </tr>
    <tr class="tr_IE_fix_bug_with_height">
      <td>
 
        <script type="text/javascript">
         document.write(
          '<comment id=\'grid_commented\'>' +
            '<object id=\'grid\'' +
              'style=\'height: 100%; width: 100%;\'' +
              'onbeforedeactivate=\'saveEditedData()\'' +
              'classid=\'..\/cbin\/TreeTable.dll#Aras.Client.Controls.GridContainer\'>' +
              '<param name=\'MenuInHeader\' value=\'true\'>' +
              '<param name=\'AllowDrop\' value=\'true\'>' +
            '<\/object>' +
          '<\/comment>');
          WriteUncommentedObject("grid_commented");
        </script>

      </td>
    </tr>
  </table>
</body>
</html>
